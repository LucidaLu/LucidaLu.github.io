<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">

<link href="//cdn.staticfile.org/KaTeX/0.7.1/katex.min.css"rel="stylesheet">











<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/luz.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/luz.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/luz.png?v=6.3.0">










<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="It&apos;s been a while.">
<meta property="og:type" content="website">
<meta property="og:title" content="Hey,Lucida is back.">
<meta property="og:url" content="http://lucida.site/page/7/index.html">
<meta property="og:site_name" content="Hey,Lucida is back.">
<meta property="og:description" content="It&apos;s been a while.">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hey,Lucida is back.">
<meta name="twitter:description" content="It&apos;s been a while.">






  <link rel="canonical" href="http://lucida.site/page/7/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Hey,Lucida is back.</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hey,Lucida is back.</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">CS</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-friends">
    <a href="/friends/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />friends</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lucida.site/SGU390/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lucida">
      <meta itemprop="description" content="It's been a while.">
      <meta itemprop="image" content="/images/luz.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hey,Lucida is back.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/SGU390/" itemprop="url">
                  SGU 390 BZOJ 2063 我爸是李刚
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-15 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-15T00:00:00+08:00">2017-03-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-17 18:00:33" itemprop="dateModified" datetime="2018-06-17T18:00:33+08:00">2018-06-17</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Link"><a href="#Link" class="headerlink" title="Link"></a><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=2063" target="_blank" rel="noopener">Link</a></h1><h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><p>不能用区间减法做了。。因为最后总能剩下那么一点，就不满足区间减法了。。
没办法，只好在计算的时候同时卡上界和下界了。
先不考虑卡上界和下界，现在找一下独立的子问题：通用的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mo>[</mo><mi>l</mi><mi>e</mi><mi>n</mi><mo>]</mo><mo>[</mo><mi>i</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">f[len][i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathit">i</span><span class="mclose">]</span></span></span></span>表示有<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">n</span></span></span></span>位，最高位为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.65952em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span></span></span></span>的方案数还可行吗？似乎不行了，原因还是一样：最后剩下的那么一点点，导致子问题不是独立的了。
那就加一维<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mo>[</mo><mi>l</mi><mi>e</mi><mi>n</mi><mo>]</mo><mo>[</mo><mi>i</mi><mo>]</mo><mo>[</mo><mi>r</mi><mi>e</mi><mi>m</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">f[len][i][rem]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathit">i</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">m</span><span class="mclose">]</span></span></span></span>表示统计完了前两维<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mo>&lt;</mo><mi>i</mi></mrow><annotation encoding="application/x-tex">&lt; len,&lt; i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mrel">&lt;</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mpunct">,</span><span class="mrel">&lt;</span><span class="mord mathit">i</span></span></span></span>的情况，剩下了一些数字数位和为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">rem</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">m</span></span></span></span>，能分的组数。然后似乎还不行：这个状态没有记录已经有的数位和，所以没法转移。那好说，注意到第二维表示成最高位的数字是意义不明(也许也可以做，但做法确实不显然)的，那就把第二维改成已经有的数位和。这样<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mo>[</mo><mi>l</mi><mi>e</mi><mi>n</mi><mo>]</mo><mo>[</mo><mi>s</mi><mi>u</mi><mi>m</mi><mo>]</mo><mo>[</mo><mi>r</mi><mi>e</mi><mi>m</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">f[len][sum][rem]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord mathit">m</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">m</span><span class="mclose">]</span></span></span></span>表示前<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">n</span></span></span></span>位的数位和为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord mathit">m</span></span></span></span>，之前剩下的数位和为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">rem</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">m</span></span></span></span>能分出的组数，就可以计算了。
注意要记录是否需要卡上下界，而且需要卡上下界的每种状态都是至多计算一次，不需要记忆化，如果记忆化了在BZOJ上就MLE了。
因为两个界都卡的只会有第一层DFS计算，剩下的都是卡一边的。而卡一边的只能从<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>e</mi><mi>n</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">len+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mbin">+</span><span class="mord mathrm">1</span></span></span></span>的卡一边的转移过来。
附<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mi>r</mi><mo>=</mo><mn>1</mn><msup><mn>0</mn><mrow><mn>1</mn><mn>8</mn></mrow></msup></mrow><annotation encoding="application/x-tex">l=1,r=10^{18}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:1.008548em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mord"><span class="mord mathrm">0</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">8</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>的需要卡上下界的状态计数
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">c[1][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[2][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[3][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[4][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[5][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[6][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[7][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[8][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[9][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[10][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[11][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[12][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[13][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[14][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[15][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[16][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[17][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[18][0][0]&lt;1,0&gt;=1</span><br><span class="line">c[1][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[2][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[3][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[4][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[5][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[6][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[7][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[8][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[9][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[10][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[11][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[12][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[13][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[14][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[15][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[16][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[17][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[18][1][483]&lt;0,1&gt;=1</span><br><span class="line">c[19][0][0]&lt;1,1&gt;=1</span><br><span class="line">126628280529273434</span><br></pre></td></tr></table></figure></p>
<h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>数位DP不只有区间减法，有可能需要一次算两边。</p>
<h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lucida"</span></span></span><br><span class="line"><span class="keyword">int</span> lbit[<span class="number">20</span>],rbit[<span class="number">20</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Convert</span><span class="params">(int64 x,<span class="keyword">int</span> bit[])</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> len=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(;x;x/=<span class="number">10</span>)</span><br><span class="line">		bit[++len]=x%<span class="number">10</span>;</span><br><span class="line">	<span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">	int64 cnt,rem;</span><br><span class="line">	Node():cnt(<span class="number">-1</span>),rem(<span class="number">0</span>)&#123;&#125;</span><br><span class="line">	Node(int64 cnt,<span class="keyword">int</span> rem):cnt(cnt),rem(rem)&#123;&#125;</span><br><span class="line">	Node &amp;<span class="keyword">operator</span> +=(<span class="keyword">const</span> Node &amp;a) &#123;</span><br><span class="line">		cnt+=a.cnt;</span><br><span class="line">		rem=a.rem;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;f[<span class="number">21</span>][<span class="number">171</span>][<span class="number">1011</span>];</span><br><span class="line">int64 l,r,M;</span><br><span class="line"><span class="function">Node <span class="title">DFS</span><span class="params">(<span class="keyword">int</span> len,<span class="keyword">int</span> sum,<span class="keyword">int</span> rem,<span class="keyword">bool</span> lm,<span class="keyword">bool</span> rm)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//sum是数位之和9*18=162</span></span><br><span class="line">	<span class="keyword">if</span>(len==<span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> (sum+rem&gt;=M)?Node(<span class="number">1</span>,<span class="number">0</span>):Node(<span class="number">0</span>,sum+rem);</span><br><span class="line">	<span class="keyword">if</span>(!lm &amp;&amp; !rm &amp;&amp; f[len][sum][rem].cnt!=<span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> f[len][sum][rem];</span><br><span class="line">	<span class="function">Node <span class="title">res</span><span class="params">(<span class="number">0</span>,rem)</span></span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=(lm?lbit[len]:<span class="number">0</span>),ei=(rm?rbit[len]:<span class="number">9</span>);i&lt;=ei;++i) </span><br><span class="line">		res+=DFS(len<span class="number">-1</span>,sum+i,res.rem,lm &amp;&amp; i==lbit[len],rm &amp;&amp; i==rbit[len]);</span><br><span class="line">	<span class="keyword">if</span>(!lm &amp;&amp; !rm) f[len][sum][rem]=res;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	freopen(<span class="string">"input"</span>,<span class="string">"r"</span>,<span class="built_in">stdin</span>);</span><br><span class="line">	is&gt;&gt;l&gt;&gt;r&gt;&gt;M;</span><br><span class="line">	Convert(l,lbit);</span><br><span class="line">	<span class="keyword">int</span> len=Convert(r,rbit);</span><br><span class="line">	int64 Ans=DFS(len,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>).cnt;</span><br><span class="line">	os&lt;&lt;Ans&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lucida.site/BZOJ4513/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lucida">
      <meta itemprop="description" content="It's been a while.">
      <meta itemprop="image" content="/images/luz.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hey,Lucida is back.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/BZOJ4513/" itemprop="url">
                  BZOJ 4513 储能表
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-15 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-15T00:00:00+08:00">2017-03-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-17 18:00:37" itemprop="dateModified" datetime="2018-06-17T18:00:37+08:00">2018-06-17</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Link"><a href="#Link" class="headerlink" title="Link"></a><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=4513" target="_blank" rel="noopener">Link</a></h1><p>真的很想自己做出来，于是就想按套路先DP预处理再用输入去卡DP值。。
然而真的想不出来。
所以套路要有，但只会套路做题也是不行的。</p>
<h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>数位DP可以边DP边卡上下界<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\times 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord">×</span><span class="mord mathrm">2</span></span></span></span>。
只要在状态里设计上需不需要继续卡边界即可<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\times 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord">×</span><span class="mord mathrm">2</span></span></span></span></p>
<h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lucida"</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXB=<span class="number">70</span>;</span><br><span class="line">int64 f[MAXB][<span class="number">2</span>][<span class="number">2</span>][<span class="number">2</span>],g[MAXB][<span class="number">2</span>][<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line"><span class="comment">//f个数					g总和</span></span><br><span class="line"><span class="function">int64 <span class="title">Solve</span><span class="params">(int64 n,int64 m,int64 K,<span class="keyword">int</span> P)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">memset</span>(f,<span class="number">0</span>,<span class="keyword">sizeof</span>(f));</span><br><span class="line">	<span class="built_in">memset</span>(g,<span class="number">0</span>,<span class="keyword">sizeof</span>(g));</span><br><span class="line">	f[<span class="number">64</span>][<span class="number">1</span>][<span class="number">1</span>][<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">	--n;--m;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">63</span>;~i;--i) &#123;</span><br><span class="line">		<span class="keyword">int</span> bn=n&gt;&gt;i&amp;<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">int</span> bm=m&gt;&gt;i&amp;<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">int</span> bk=K&gt;&gt;i&amp;<span class="number">1</span>;<span class="comment">//bn^bm;</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> fns=<span class="number">0</span>;fns&lt;<span class="number">2</span>;++fns)</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> fms=<span class="number">0</span>;fms&lt;<span class="number">2</span>;++fms)</span><br><span class="line">				<span class="keyword">for</span>(<span class="keyword">int</span> fks=<span class="number">0</span>;fks&lt;<span class="number">2</span>;++fks)</span><br><span class="line">					<span class="keyword">for</span>(<span class="keyword">int</span> newn=<span class="number">0</span>;newn&lt;<span class="number">2</span>;++newn)</span><br><span class="line">						<span class="keyword">for</span>(<span class="keyword">int</span> newm=<span class="number">0</span>;newm&lt;<span class="number">2</span>;++newm) &#123;</span><br><span class="line">							<span class="keyword">int</span> newk=newn^newm;</span><br><span class="line">							<span class="keyword">if</span>((fns &amp;&amp; newn&gt;bn) || (fms &amp;&amp; newm&gt;bm) || (fks &amp;&amp; newk&lt;bk)) <span class="keyword">continue</span>;</span><br><span class="line">							<span class="keyword">int</span> gns=fns &amp;&amp; (newn==bn),</span><br><span class="line">								gms=fms &amp;&amp; (newm==bm),</span><br><span class="line">								gks=fks &amp;&amp; (newk==bk);</span><br><span class="line">							(f[i][gns][gms][gks]+=f[i+<span class="number">1</span>][fns][fms][fks])%=P;</span><br><span class="line">							(g[i][gns][gms][gks]+=(g[i+<span class="number">1</span>][fns][fms][fks]+(f[i+<span class="number">1</span>][fns][fms][fks]*(((int64)newk&lt;&lt;i)%P))%P))%=P;</span><br><span class="line">						&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	int64 Ans=<span class="number">0</span>;K%=P;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> ns=<span class="number">0</span>;ns&lt;<span class="number">2</span>;++ns)</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> ms=<span class="number">0</span>;ms&lt;<span class="number">2</span>;++ms)</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> ks=<span class="number">0</span>;ks&lt;<span class="number">2</span>;++ks)</span><br><span class="line">				(Ans+=g[<span class="number">0</span>][ns][ms][ks]-K*f[<span class="number">0</span>][ns][ms][ks])%=P;</span><br><span class="line">	<span class="keyword">return</span> (Ans+P)%P;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	freopen(<span class="string">"input"</span>,<span class="string">"r"</span>,<span class="built_in">stdin</span>);</span><br><span class="line">	<span class="keyword">int</span> T;is&gt;&gt;T;</span><br><span class="line">	<span class="keyword">while</span>(T--) &#123;</span><br><span class="line">		int64 n,m,K;</span><br><span class="line">		<span class="keyword">int</span> P;</span><br><span class="line">		is&gt;&gt;n&gt;&gt;m&gt;&gt;K&gt;&gt;P;</span><br><span class="line">		os&lt;&lt;Solve(n,m,K,P)&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lucida.site/BZOJ1026/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lucida">
      <meta itemprop="description" content="It's been a while.">
      <meta itemprop="image" content="/images/luz.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hey,Lucida is back.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/BZOJ1026/" itemprop="url">
                  BZOJ 1026 Windy数字
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-14 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-14T00:00:00+08:00">2017-03-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-17 18:00:39" itemprop="dateModified" datetime="2018-06-17T18:00:39+08:00">2018-06-17</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Link"><a href="#Link" class="headerlink" title="Link"></a><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=1026" target="_blank" rel="noopener">Link</a></h1><h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><p>数位DP模板？</p>
<p>然而有一点需要注意：长度不足<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span></span></span></span>的必须单独算(或者我没想出好办法？)</p>
<p>想了很长时间想巧妙地避免分开处理，发现不好避免。</p>
<p>所以数位DP就可以类比AC自动机DP，可以把长度小于给定串的单独处理。</p>
<h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lucida"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> f[<span class="number">15</span>][<span class="number">10</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DP</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;++i)</span><br><span class="line">		f[<span class="number">1</span>][i]=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">10</span>;++i)</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">10</span>;++j)</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">0</span>;k&lt;<span class="number">10</span>;++k)</span><br><span class="line">				f[i][j]+=(<span class="built_in">abs</span>(j-k)&gt;=<span class="number">2</span>)*f[i<span class="number">-1</span>][k];</span><br><span class="line">				<span class="comment">//j==0? is that right?</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Cute</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> bit[<span class="number">15</span>],len;</span><br><span class="line">	<span class="comment">//if(x==0) return 0;</span></span><br><span class="line">	<span class="keyword">for</span>(len=<span class="number">0</span>,++x;x;x/=<span class="number">10</span>)</span><br><span class="line">		bit[++len]=x%<span class="number">10</span>;</span><br><span class="line">	bit[len+<span class="number">1</span>]=<span class="number">2333</span>;</span><br><span class="line">	<span class="keyword">int</span> res=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=len<span class="number">-1</span>;i;--i)</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;<span class="number">10</span>;++j)</span><br><span class="line">			res+=f[i][j];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=len;i;--i) &#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=(i==len);j&lt;bit[i];++j)</span><br><span class="line">			res+=(<span class="built_in">abs</span>(bit[i+<span class="number">1</span>]-j)&gt;=<span class="number">2</span>)*f[i][j];</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">abs</span>(bit[i+<span class="number">1</span>]-bit[i])&lt;<span class="number">2</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	freopen(<span class="string">"input"</span>,<span class="string">"r"</span>,<span class="built_in">stdin</span>);</span><br><span class="line">	DP();</span><br><span class="line">	<span class="keyword">int</span> l,r;</span><br><span class="line">	is&gt;&gt;l&gt;&gt;r;</span><br><span class="line">	os&lt;&lt;(Cute(r)-Cute(l<span class="number">-1</span>))&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lucida.site/BZOJ3323/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lucida">
      <meta itemprop="description" content="It's been a while.">
      <meta itemprop="image" content="/images/luz.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hey,Lucida is back.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/BZOJ3323/" itemprop="url">
                  BZOJ 3323 多项式的运算
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-14 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-14T00:00:00+08:00">2017-03-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-18 18:23:51" itemprop="dateModified" datetime="2018-06-18T18:23:51+08:00">2018-06-18</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Link"><a href="#Link" class="headerlink" title="Link"></a><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=3323" target="_blank" rel="noopener">Link</a></h1><p>一开始被题意唬了一下。。</p>
<h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><p>对mulx操作，在左边插入一个0，删掉右端点并把系数加到右端点右边的端点
注意含有0，所以需要加加减减，然而Splay内部的空节点也要加加减减，所以要小心</p>
<h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lucida"</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN=<span class="number">1e5</span>+<span class="number">11</span>,P=<span class="number">20130426</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Line</span> &#123;</span></span><br><span class="line">	int64 k,b;</span><br><span class="line">	Line():k(<span class="number">1</span>),b(<span class="number">0</span>)&#123;&#125;</span><br><span class="line">	Line(int64 k,int64 b):k(k),b(b)&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> !(k==<span class="number">1</span> &amp;&amp; b==<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">int64 <span class="title">operator</span> <span class="params">()</span> <span class="params">(int64 x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (k*x+b)%P;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">Line <span class="title">operator</span> <span class="params">()</span> <span class="params">(Line x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Line(k*x.k%P,(k*x.b+b)%P);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">namespace</span> splay &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Node</span> *<span class="title">null</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">		Node *son[<span class="number">2</span>],*fa;</span><br><span class="line">		int64 v;<span class="keyword">int</span> sz;Line mrk;</span><br><span class="line">		Node():v(v),sz(<span class="number">0</span>) &#123;</span><br><span class="line">			son[<span class="number">0</span>]=son[<span class="number">1</span>]=fa=null;</span><br><span class="line">		&#125;</span><br><span class="line">		Node(int64 v):v(v),sz(<span class="number">1</span>) &#123;</span><br><span class="line">			son[<span class="number">0</span>]=son[<span class="number">1</span>]=fa=null;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> *<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span>)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">static</span> Node *Me=alloc(Node,MAXN&lt;&lt;<span class="number">2</span>);</span><br><span class="line">			<span class="keyword">return</span> Me++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">bool</span> <span class="title">isRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> fa==null;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">int</span> <span class="title">Kind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> fa-&gt;son[<span class="number">1</span>]==<span class="keyword">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Modify</span><span class="params">(Line ln)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">this</span>==null) </span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			v=ln(v);</span><br><span class="line">			mrk=ln(mrk);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Up</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			sz=son[<span class="number">0</span>]-&gt;sz+son[<span class="number">1</span>]-&gt;sz+<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Down</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(mrk) &#123;</span><br><span class="line">				son[<span class="number">0</span>]-&gt;Modify(mrk);</span><br><span class="line">				son[<span class="number">1</span>]-&gt;Modify(mrk);</span><br><span class="line">				mrk.k=<span class="number">1</span>;mrk.b=<span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;*llun=null=<span class="keyword">new</span> Node;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Splay</span> &#123;</span></span><br><span class="line">		Node *root;</span><br><span class="line">		Splay()&#123;</span><br><span class="line">			(root=<span class="keyword">new</span> Node(<span class="number">0</span>))-&gt;son[<span class="number">1</span>]=<span class="keyword">new</span> Node(<span class="number">0</span>);</span><br><span class="line">			(root-&gt;son[<span class="number">1</span>]-&gt;fa=root)-&gt;Up();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Trans</span><span class="params">(Node *pos)</span> </span>&#123;</span><br><span class="line">			Node *f=pos-&gt;fa,*grf=f-&gt;fa;</span><br><span class="line">			f-&gt;Down();pos-&gt;Down();<span class="comment">//反过来写会导致一些标记下传2次</span></span><br><span class="line">			<span class="keyword">int</span> d=pos-&gt;Kind();</span><br><span class="line">			<span class="keyword">if</span>(!f-&gt;isRoot())</span><br><span class="line">				grf-&gt;son[f-&gt;Kind()]=pos;</span><br><span class="line">			pos-&gt;fa=grf;<span class="comment">//没写??</span></span><br><span class="line">			f-&gt;son[d]=pos-&gt;son[!d];pos-&gt;son[!d]-&gt;fa=f;</span><br><span class="line">			pos-&gt;son[!d]=f;f-&gt;fa=pos;</span><br><span class="line">			f-&gt;Up();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">SplayTo</span><span class="params">(Node *pos,Node *goal)</span> </span>&#123;</span><br><span class="line">			Node *f;</span><br><span class="line">			<span class="keyword">while</span>((f=pos-&gt;fa)!=goal) &#123;</span><br><span class="line">				<span class="keyword">if</span>(f-&gt;fa!=goal)</span><br><span class="line">					Trans(f-&gt;Kind()==pos-&gt;Kind()?f:pos);</span><br><span class="line">				Trans(pos);</span><br><span class="line">			&#125;</span><br><span class="line">			pos-&gt;Up();</span><br><span class="line">			<span class="keyword">if</span>(goal==null)</span><br><span class="line">				root=pos;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function">Node *<span class="title">Kth</span><span class="params">(<span class="keyword">int</span> K)</span> </span>&#123;</span><br><span class="line">			++K;</span><br><span class="line">			Node *pos=root;<span class="keyword">int</span> c;</span><br><span class="line">			<span class="keyword">while</span>(pos!=null) &#123;</span><br><span class="line">				<span class="keyword">if</span>((c=pos-&gt;son[<span class="number">0</span>]-&gt;sz+<span class="number">1</span>)==K)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span>(K&lt;c)</span><br><span class="line">					pos=pos-&gt;son[<span class="number">0</span>];</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					pos=pos-&gt;son[<span class="number">1</span>];</span><br><span class="line">					K-=c;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			SplayTo(pos,null);</span><br><span class="line">			<span class="keyword">return</span> pos;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function">Node *<span class="title">Split</span><span class="params">(<span class="keyword">int</span> L,<span class="keyword">int</span> R)</span> </span>&#123;</span><br><span class="line">			Node *p1=Kth(L<span class="number">-1</span>),*p2=Kth(R+<span class="number">1</span>);</span><br><span class="line">			SplayTo(p1,null);</span><br><span class="line">			SplayTo(p2,p1);</span><br><span class="line">			<span class="keyword">return</span> p2-&gt;son[<span class="number">0</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">int</span> pos,Node *newn)</span> </span>&#123;</span><br><span class="line">			Node *p1=Kth(pos),*p2=Kth(pos+<span class="number">1</span>);</span><br><span class="line">			SplayTo(p1,null);</span><br><span class="line">			SplayTo(p2,p1);</span><br><span class="line">			p1-&gt;Down(),p2-&gt;Down();</span><br><span class="line">			p2-&gt;son[<span class="number">0</span>]=newn;newn-&gt;fa=p2;</span><br><span class="line">			SplayTo(newn,null);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function">Node* <span class="title">Insert</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">			Node *newn=<span class="keyword">new</span> Node(v);</span><br><span class="line">			Insert(pos,newn);</span><br><span class="line">			<span class="keyword">return</span> newn;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Delete</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">			Node *rt=Split(pos,pos);</span><br><span class="line">			rt-&gt;fa-&gt;son[<span class="number">0</span>]=null;<span class="comment">//rt-&gt;son[0]=null...</span></span><br><span class="line">			SplayTo(rt-&gt;fa,null);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function">Node *<span class="title">Build</span><span class="params">(<span class="keyword">int</span> L,<span class="keyword">int</span> R)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">int</span> Mid=(L+R)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			Node *pos=<span class="keyword">new</span> Node(<span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span>(L!=Mid)</span><br><span class="line">				(pos-&gt;son[<span class="number">0</span>]=Build(L,Mid<span class="number">-1</span>))-&gt;fa=pos;</span><br><span class="line">			<span class="keyword">if</span>(Mid!=R)</span><br><span class="line">				(pos-&gt;son[<span class="number">1</span>]=Build(Mid+<span class="number">1</span>,R))-&gt;fa=pos;</span><br><span class="line">			pos-&gt;Up();</span><br><span class="line">			<span class="keyword">return</span> pos;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Make</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">int</span> sz=root-&gt;sz<span class="number">-2</span>;</span><br><span class="line">			<span class="keyword">if</span>((size-=sz)&gt;<span class="number">0</span>)</span><br><span class="line">				Insert(sz,Build(<span class="number">1</span>,size));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//对外的interface L,R是包含0的</span></span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Modify</span><span class="params">(<span class="keyword">int</span> L,<span class="keyword">int</span> R,Line ln)</span> </span>&#123;</span><br><span class="line">			++L,++R;</span><br><span class="line">			Make(R);</span><br><span class="line">			Node *rt=Split(L,R);</span><br><span class="line">			rt-&gt;Modify(ln);</span><br><span class="line">			SplayTo(rt,null);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function">int64* <span class="title">Out</span><span class="params">(Node *pos,<span class="keyword">int</span> &amp;cnt)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">static</span> int64 seq[MAXN];</span><br><span class="line">			<span class="keyword">if</span>(pos!=null) &#123;</span><br><span class="line">				pos-&gt;Down();</span><br><span class="line">				Out(pos-&gt;son[<span class="number">0</span>],cnt);</span><br><span class="line">				seq[++cnt]=pos-&gt;v;</span><br><span class="line">				Out(pos-&gt;son[<span class="number">1</span>],cnt);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> seq;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">int</span> cnt=<span class="number">0</span>;</span><br><span class="line">			int64 *s=Out(root,cnt);</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=cnt;++i)</span><br><span class="line">				os&lt;&lt;s[i]&lt;&lt;<span class="string">' '</span>;</span><br><span class="line">			os&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">int</span> <span class="title">Query</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">			v%=P;</span><br><span class="line">			<span class="keyword">int</span> cnt=<span class="number">0</span>;</span><br><span class="line">			int64 *s=Out(root,cnt);</span><br><span class="line">			int64 powx=<span class="number">1</span>,res=<span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=cnt<span class="number">-1</span>;++i) &#123;</span><br><span class="line">				(res+=powx*s[i])%=P;</span><br><span class="line">				(powx*=v)%=P;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> res;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Mulx</span><span class="params">(<span class="keyword">int</span> L,<span class="keyword">int</span> R)</span> </span>&#123;</span><br><span class="line">			++L,++R;</span><br><span class="line">			Make(R+<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">int</span> rv=Kth(R)-&gt;v;</span><br><span class="line">			Delete(R);</span><br><span class="line">			Insert(L<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">			Modify(R,R,Line(<span class="number">1</span>,rv));<span class="comment">//Modify是对外部的interface 会自行++</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;<span class="keyword">using</span> splay::Splay;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	freopen(<span class="string">"input"</span>,<span class="string">"r"</span>,<span class="built_in">stdin</span>);</span><br><span class="line">	<span class="keyword">int</span> n;is&gt;&gt;n;</span><br><span class="line">	Splay sp;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i) &#123;</span><br><span class="line">		<span class="keyword">char</span> opt[<span class="number">10</span>];<span class="keyword">int</span> L,R,v,Ans;</span><br><span class="line">		is&gt;&gt;opt;</span><br><span class="line">		<span class="keyword">switch</span>(opt[<span class="number">0</span>]) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">'m'</span>:</span><br><span class="line">				<span class="keyword">if</span>(opt[<span class="number">3</span>]==<span class="string">'x'</span>) &#123;</span><br><span class="line">					is&gt;&gt;L&gt;&gt;R;</span><br><span class="line">					sp.Mulx(L,R);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					is&gt;&gt;L&gt;&gt;R&gt;&gt;v;</span><br><span class="line">					sp.Modify(L,R,Line(v,<span class="number">0</span>));</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">'a'</span>:</span><br><span class="line">				is&gt;&gt;L&gt;&gt;R&gt;&gt;v;</span><br><span class="line">				sp.Modify(L,R,Line(<span class="number">1</span>,v));</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">'q'</span>:</span><br><span class="line">				is&gt;&gt;v;</span><br><span class="line">				Ans=sp.Query(v);</span><br><span class="line">				os&lt;&lt;Ans&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lucida.site/BZOJ3307/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lucida">
      <meta itemprop="description" content="It's been a while.">
      <meta itemprop="image" content="/images/luz.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hey,Lucida is back.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/BZOJ3307/" itemprop="url">
                  BZOJ 3307 雨天的尾巴
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-14 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-14T00:00:00+08:00">2017-03-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-18 18:23:51" itemprop="dateModified" datetime="2018-06-18T18:23:51+08:00">2018-06-18</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Link"><a href="#Link" class="headerlink" title="Link"></a><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=3307" target="_blank" rel="noopener">Link</a></h1><p>总算明白了大神们口中说的“剖完之后套用链上做法”的方法了。。。</p>
<h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><p>要对链加标记算前缀和，要想办法转化成序列的问题。然而普通的DFS序可能会把路径弄成很多段，这不好。如果用树链剖分剖出的DFS序，一个路径在DFS序上最多<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>log</mi><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>段，就好了。</p>
<h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lucida"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> alloc(T,c) (T*)malloc((c)*sizeof(T))</span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::lower_bound;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::sort;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::unique;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">vector</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::swap;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::max;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN=<span class="number">100000</span>+<span class="number">11</span>;</span><br><span class="line"><span class="keyword">int</span> nums[MAXN],nc;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ref(x) (lower_bound(nums+1,nums+1+nc,(x))-nums)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> to;</span><br><span class="line">	Edge *pre;</span><br><span class="line">	Edge(<span class="keyword">int</span> to,Edge *pre):to(to),pre(pre)&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> *<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span>)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">static</span> Edge *Me=alloc(Edge,MAXN&lt;&lt;<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">return</span> Me++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;*G[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Adde</span><span class="params">(<span class="keyword">int</span> f,<span class="keyword">int</span> t)</span> </span>&#123;</span><br><span class="line">	G[f]=<span class="keyword">new</span> Edge(t,G[f]);</span><br><span class="line">	G[t]=<span class="keyword">new</span> Edge(f,G[t]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> dep[MAXN],sz[MAXN],prefer[MAXN],fa[MAXN],cht[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DFS</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">	sz[pos]=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(Edge *e=G[pos];e;e=e-&gt;pre)</span><br><span class="line">		<span class="keyword">if</span>(fa[pos]!=e-&gt;to) &#123;</span><br><span class="line">			<span class="keyword">int</span> u=e-&gt;to;</span><br><span class="line">			fa[u]=pos;</span><br><span class="line">			dep[u]=dep[pos]+<span class="number">1</span>;</span><br><span class="line">			DFS(u);</span><br><span class="line">			sz[pos]+=sz[u];</span><br><span class="line">			<span class="keyword">if</span>(sz[u]&gt;sz[prefer[pos]])</span><br><span class="line">				prefer[pos]=u;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> dfn[MAXN],dfs[MAXN],dc;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Assign</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">	dfs[++dc]=pos;</span><br><span class="line">	dfn[pos]=dc;</span><br><span class="line">	<span class="keyword">if</span>(prefer[pos]) &#123;</span><br><span class="line">		cht[prefer[pos]]=cht[pos];</span><br><span class="line">		Assign(prefer[pos]);</span><br><span class="line">		<span class="keyword">for</span>(Edge *e=G[pos];e;e=e-&gt;pre)</span><br><span class="line">			<span class="keyword">if</span>(e-&gt;to!=prefer[pos] &amp;&amp; fa[pos]!=e-&gt;to) &#123;</span><br><span class="line">				cht[e-&gt;to]=e-&gt;to;</span><br><span class="line">				Assign(e-&gt;to);</span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Divide</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	DFS(<span class="number">1</span>);</span><br><span class="line">	cht[<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">	Assign(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Data</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> cnt,id;</span><br><span class="line">	Data(<span class="keyword">int</span> cnt,<span class="keyword">int</span> id):cnt(cnt),id(id)&#123;&#125;</span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">operator</span> &lt;(<span class="keyword">const</span> Data &amp;a) <span class="keyword">const</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> cnt==a.cnt?id&gt;a.id:cnt&lt;a.cnt;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Tag</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> v,cnt;</span><br><span class="line">	Tag(<span class="keyword">int</span> v,<span class="keyword">int</span> cnt):v(v),cnt(cnt)&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">vector</span>&lt;Tag&gt; tag[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Modify</span><span class="params">(<span class="keyword">int</span> p1,<span class="keyword">int</span> p2,<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">while</span>(cht[p1]!=cht[p2]) &#123;</span><br><span class="line">		<span class="keyword">if</span>(dep[cht[p1]]&lt;dep[cht[p2]])</span><br><span class="line">			swap(p1,p2);</span><br><span class="line">		tag[dfn[cht[p1]]].push_back(Tag(c,<span class="number">1</span>));</span><br><span class="line">		tag[dfn[p1]+<span class="number">1</span>].push_back(Tag(c,<span class="number">-1</span>));</span><br><span class="line">		p1=fa[cht[p1]];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(dep[p1]&gt;dep[p2])</span><br><span class="line">		swap(p1,p2);</span><br><span class="line">	tag[dfn[p1]].push_back(Tag(c,<span class="number">1</span>));</span><br><span class="line">	tag[dfn[p2]+<span class="number">1</span>].push_back(Tag(c,<span class="number">-1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> segtree &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">		Node *son[<span class="number">2</span>];</span><br><span class="line">		Data maxv;</span><br><span class="line">		Node(Data maxv):maxv(maxv) &#123;</span><br><span class="line">			son[<span class="number">0</span>]=son[<span class="number">1</span>]=<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> *<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span>)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">static</span> Node *Me=alloc(Node,MAXN&lt;&lt;<span class="number">2</span>);</span><br><span class="line">			<span class="keyword">return</span> Me++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Up</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			maxv=max(son[<span class="number">0</span>]-&gt;maxv,son[<span class="number">1</span>]-&gt;maxv);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">SegTree</span> &#123;</span></span><br><span class="line">		Node *root;</span><br><span class="line">		<span class="keyword">int</span> L,R;</span><br><span class="line">		Node *<span class="keyword">operator</span> -&gt;() &#123;</span><br><span class="line">			<span class="keyword">return</span> root;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		operator Node *() &#123;</span></span><br><span class="line"><span class="comment">			return root;</span></span><br><span class="line"><span class="comment">		&#125; */</span></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Build</span><span class="params">(Node *&amp;pos,<span class="keyword">int</span> L,<span class="keyword">int</span> R)</span> </span>&#123;</span><br><span class="line">			pos=<span class="keyword">new</span> Node(Data(<span class="number">0</span>,L));</span><br><span class="line">			<span class="keyword">if</span>(L!=R) &#123;</span><br><span class="line">				<span class="keyword">int</span> Mid=(L+R)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">				Build(pos-&gt;son[<span class="number">0</span>],L,Mid);</span><br><span class="line">				Build(pos-&gt;son[<span class="number">1</span>],Mid+<span class="number">1</span>,R);</span><br><span class="line">				pos-&gt;Up();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Edit</span><span class="params">(Node *pos,<span class="keyword">int</span> L,<span class="keyword">int</span> R,<span class="keyword">int</span> goal,<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(L==R)</span><br><span class="line">				pos-&gt;maxv.cnt+=v;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">int</span> Mid=(L+R)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">				<span class="keyword">if</span>(goal&lt;=Mid)</span><br><span class="line">					Edit(pos-&gt;son[<span class="number">0</span>],L,Mid,goal,v);</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					Edit(pos-&gt;son[<span class="number">1</span>],Mid+<span class="number">1</span>,R,goal,v);</span><br><span class="line">				pos-&gt;Up();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		SegTree(<span class="keyword">int</span> L,<span class="keyword">int</span> R):L(L),R(R) &#123;</span><br><span class="line">			Build(root,L,R);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Edit</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">			Edit(root,L,R,pos,v);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;<span class="keyword">using</span> segtree::SegTree;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	freopen(<span class="string">"input"</span>,<span class="string">"r"</span>,<span class="built_in">stdin</span>);</span><br><span class="line">	<span class="keyword">int</span> n,m;</span><br><span class="line">	is&gt;&gt;n&gt;&gt;m;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n<span class="number">-1</span>;++i) &#123;</span><br><span class="line">		<span class="keyword">int</span> x,y;</span><br><span class="line">		is&gt;&gt;x&gt;&gt;y;</span><br><span class="line">		Adde(x,y);</span><br><span class="line">	&#125;</span><br><span class="line">	Divide();</span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span><span class="keyword">int</span> p1,p2,c;&#125;op[MAXN];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;++i) &#123;</span><br><span class="line">		is&gt;&gt;op[i].p1&gt;&gt;op[i].p2&gt;&gt;op[i].c;</span><br><span class="line">		nums[++nc]=op[i].c;</span><br><span class="line">	&#125;</span><br><span class="line">	sort(nums+<span class="number">1</span>,nums+<span class="number">1</span>+nc);</span><br><span class="line">	nc=unique(nums+<span class="number">1</span>,nums+<span class="number">1</span>+nc)-nums<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;++i)</span><br><span class="line">		Modify(op[i].p1,op[i].p2,ref(op[i].c));</span><br><span class="line">	<span class="function">SegTree <span class="title">seg</span><span class="params">(<span class="number">1</span>,nc)</span></span>;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> Ans[MAXN];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i) &#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="built_in">vector</span>&lt;Tag&gt;::iterator it=tag[i].begin();it!=tag[i].end();++it)</span><br><span class="line">			seg.Edit(it-&gt;v,it-&gt;cnt);</span><br><span class="line">		Ans[dfs[i]]=nums[seg-&gt;maxv.cnt==<span class="number">0</span>?<span class="number">0</span>:seg-&gt;maxv.id];		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i)</span><br><span class="line">		os&lt;&lt;Ans[i]&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lucida.site/BZOJ2821/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lucida">
      <meta itemprop="description" content="It's been a while.">
      <meta itemprop="image" content="/images/luz.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hey,Lucida is back.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/BZOJ2821/" itemprop="url">
                  BZOJ 2821 作诗
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-14 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-14T00:00:00+08:00">2017-03-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-18 18:23:51" itemprop="dateModified" datetime="2018-06-18T18:23:51+08:00">2018-06-18</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Link"><a href="#Link" class="headerlink" title="Link"></a><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=2821" target="_blank" rel="noopener">Link</a></h1><p>sro <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.391ex" height="2.509ex" style="vertical-align: -0.671ex;" viewbox="-54.5 -791.3 1890.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-6A" d="M98 609Q98 637 116 653T160 669Q183 667 200 652T217 609Q217 579 200 564T158 549Q133 549 116 564T98 609ZM28 -163Q58 -168 64 -168Q124 -168 135 -77Q137 -65 137 141T136 353Q132 371 120 377T72 385H52V408Q52 431 54 431L58 432Q62 432 70 432T87 433T108 434T133 436Q151 437 171 438T202 441T214 442H218V184Q217 -36 217 -59T211 -98Q195 -145 153 -175T58 -205Q9 -205 -23 -179T-55 -117Q-55 -94 -40 -79T-2 -64T36 -79T52 -118Q52 -143 28 -163Z"/>
<path stroke-width="1" id="E1-MJMAIN-63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z"/>
<path stroke-width="1" id="E1-MJMAIN-76" d="M338 431Q344 429 422 429Q479 429 503 431H508V385H497Q439 381 423 345Q421 341 356 172T288 -2Q283 -11 263 -11Q244 -11 239 -2Q99 359 98 364Q93 378 82 381T43 385H19V431H25L33 430Q41 430 53 430T79 430T104 429T122 428Q217 428 232 431H240V385H226Q187 384 184 370Q184 366 235 234L286 102L377 341V349Q377 363 367 372T349 383T335 385H331V431H338Z"/>
<path stroke-width="1" id="E1-MJMAIN-62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-6A" x="0" y="0"/>
 <use xlink:href="#E1-MJMAIN-63" x="306" y="0"/>
 <use xlink:href="#E1-MJMAIN-76" x="751" y="0"/>
 <use xlink:href="#E1-MJMAIN-62" x="1279" y="0"/>
</g>
</svg> orz</p>
<h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><p>预处理出块与块之间的答案，预处理出每个数字在前<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.65952em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span></span></span></span>块的出现次数
然后对于零散部分遍历，记录每个数字的出现次数，利用整块的某个数字的奇偶性判断对答案的贡献+1/-1。</p>
<h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>似乎序列分块的大体套路就是处理块与块的答案和想办法快速地计算零碎部分对答案的贡献？</p>
<h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lucida"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::swap;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::partial_sum;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN=<span class="number">1e5</span>+<span class="number">5</span>,MAXB=<span class="number">320</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MagicArray</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> a[MAXN],us[MAXN],ut;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		++ut;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> &amp;<span class="keyword">operator</span> [](<span class="keyword">int</span> x) &#123;</span><br><span class="line">		<span class="keyword">if</span>(us[x]!=ut) &#123;</span><br><span class="line">			us[x]=ut;</span><br><span class="line">			a[x]=<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> a[x];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;counter;</span><br><span class="line"><span class="keyword">int</span> a[MAXN],n,bsz,bc,bn[MAXN],bhe[MAXN],bAns[MAXB][MAXB],cext[MAXN][MAXB];</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">valid</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> x &amp;&amp; (!(x&amp;<span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Query</span><span class="params">(<span class="keyword">int</span> l,<span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">	counter.Reset();</span><br><span class="line">	<span class="keyword">int</span> res=<span class="number">0</span>,c;</span><br><span class="line">	<span class="keyword">if</span>(bn[r]-bn[l]&lt;=<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=l;i&lt;=r;++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(valid(c=++counter[a[i]])) res++;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(c!=<span class="number">1</span>) res--;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">int</span> lbo=bn[l]+<span class="number">1</span>,rbo=bn[r]<span class="number">-1</span>;</span><br><span class="line">		res=bAns[lbo][rbo];</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=l;i&lt;bhe[lbo];++i)</span><br><span class="line">			<span class="keyword">if</span>(valid(c=(++counter[a[i]]+cext[a[i]][rbo]-cext[a[i]][lbo<span class="number">-1</span>]))) res++;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(c!=<span class="number">1</span>) res--;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=bhe[bn[r]];i&lt;=r;++i)</span><br><span class="line">			<span class="keyword">if</span>(valid(c=(++counter[a[i]]+cext[a[i]][rbo]-cext[a[i]][lbo<span class="number">-1</span>]))) res++;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(c!=<span class="number">1</span>) res--;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	freopen(<span class="string">"input"</span>,<span class="string">"r"</span>,<span class="built_in">stdin</span>);</span><br><span class="line">	<span class="keyword">int</span> c,m;</span><br><span class="line">	is&gt;&gt;n&gt;&gt;c&gt;&gt;m;</span><br><span class="line">	bsz=(<span class="keyword">int</span>)<span class="built_in">sqrt</span>(n);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i) &#123;</span><br><span class="line">		is&gt;&gt;a[i];</span><br><span class="line">		bn[i]=(i<span class="number">-1</span>)/bsz+<span class="number">1</span>;</span><br><span class="line">		bhe[bn[i]]=bn[i<span class="number">-1</span>]!=bn[i]?i:bhe[bn[i]];</span><br><span class="line">	&#125;</span><br><span class="line">	bc=bn[n];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i)</span><br><span class="line">		cext[a[i]][bn[i]]++;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i)</span><br><span class="line">		partial_sum(cext[i]+<span class="number">1</span>,cext[i]+<span class="number">1</span>+bc,cext[i]+<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> lb=<span class="number">1</span>;lb&lt;=bc;++lb) &#123;</span><br><span class="line">		counter.Reset();</span><br><span class="line">		<span class="keyword">int</span> cnt=<span class="number">0</span>,c;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=bhe[lb];i&lt;=n;++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(valid(c=++counter[a[i]])) cnt++;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(c!=<span class="number">1</span>) cnt--;</span><br><span class="line">			<span class="keyword">if</span>(bn[i]!=bn[i+<span class="number">1</span>])</span><br><span class="line">				bAns[lb][bn[i]]=cnt;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> Ans=<span class="number">0</span>;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> decode(x) (((x+=Ans)%=n)+=1)</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;++i) &#123;</span><br><span class="line">		<span class="keyword">int</span> l,r;is&gt;&gt;l&gt;&gt;r;</span><br><span class="line">		decode(l),decode(r);</span><br><span class="line">		<span class="keyword">if</span>(l&gt;r) swap(l,r);</span><br><span class="line">		os&lt;&lt;(Ans=Query(l,r))&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lucida.site/BZOJ1146/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lucida">
      <meta itemprop="description" content="It's been a while.">
      <meta itemprop="image" content="/images/luz.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hey,Lucida is back.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/BZOJ1146/" itemprop="url">
                  BZOJ 1146 网络管理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-13 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-13T00:00:00+08:00">2017-03-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-18 18:23:51" itemprop="dateModified" datetime="2018-06-18T18:23:51+08:00">2018-06-18</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Link"><a href="#Link" class="headerlink" title="Link"></a><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=1146" target="_blank" rel="noopener">Link</a></h1><p>小时候写过树状数组套主席树的版本，时空<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><msup><mi>log</mi><mn>2</mn></msup><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n\log^2n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>。众所周知，这个空间复杂度是非常不友好的。
今天翻到jcvb巨神的博客，发现他给了一种非常interesting的做法：值域线段树套区间平衡树。研究一番，写完之后感觉很不错。</p>
<h1 id="树状数组套主席树维护DFS序"><a href="#树状数组套主席树维护DFS序" class="headerlink" title="树状数组套主席树维护DFS序"></a>树状数组套主席树维护DFS序</h1><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>众所周知，序列上的主席树可以利用可持久化实现时空<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><mi>log</mi><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>的前缀和，从而解决区间K值问题。
放到树上，如果不带修改，那就可以直接用序列的可持久化线段树方法，从根节点DFS下去，在节点<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">u</span></span></span></span>的值域线段树的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span>区间，维护<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">u</span></span></span></span>到<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>o</mi><mi>o</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">root</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.61508em;"></span><span class="strut bottom" style="height:0.61508em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">o</span><span class="mord mathit">o</span><span class="mord mathit">t</span></span></span></span>路径上值在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span>的节点个数。这样，两点<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>u</mi><mo separator="true">,</mo><mi>v</mi></mrow><annotation encoding="application/x-tex">u,v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">u</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">v</span></span></span></span>的路径上，值在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span>的节点个数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mo>(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">c(u,v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mopen">(</span><span class="mord mathit">u</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>，就是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mo>(</mo><mi>u</mi><mo>)</mo><mo>+</mo><mi>c</mi><mo>(</mo><mi>v</mi><mo>)</mo><mo>−</mo><mi>c</mi><mo>(</mo><mi>l</mi><mi>c</mi><mi>a</mi><mo>)</mo><mo>−</mo><mi>c</mi><mo>(</mo><mi>f</mi><mi>a</mi><mo>[</mo><mi>l</mi><mi>c</mi><mi>a</mi><mo>]</mo><mo>)</mo></mrow><annotation encoding="application/x-tex">c(u)+c(v)-c(lca)-c(fa[lca])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mopen">(</span><span class="mord mathit">u</span><span class="mclose">)</span><span class="mbin">+</span><span class="mord mathit">c</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mbin">−</span><span class="mord mathit">c</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mclose">)</span><span class="mbin">−</span><span class="mord mathit">c</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">a</span><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mclose">]</span><span class="mclose">)</span></span></span></span>。套用序列的方法查询即可。
现在有了修改，显然不可能暴力重建主席树，因为一次修改会影响子树的所有的点。
等等，一次修改影响子树所有的点？不禁让人思考能否进行区间操作？然后就联想到了DFS序。没错，DFS序就是一个满足子树的所有点是一个区间的序列。
区间操作的两种办法：用兹瓷区间修改的数据结构打标记；或者差分，把区间修改变成单点修改。待修改的树上主席树是通过套一个树状数组，绝对化相对的方法来实现的。这样，线段树就不需要可持久化了，因为本来可持久化是要维护前缀和，但现在树状数组就维护了前缀和。一次修改，会修改<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>log</mi><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>个线段树，每个线段树修改的时间是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>log</mi><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>。一个点的值至多将在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>log</mi><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>个线段树出现，粗略地估计总次数，绝对不会超过<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>log</mi><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>。所以得到了一个时空<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><msup><mi>log</mi><mn>2</mn></msup><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n\log ^2n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>的优秀做法。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S(X,NUMO) seg[X].son[NUMO]</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN=<span class="number">80010</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXLOGN=<span class="number">18</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXRG=MAXN*<span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXLOGRG=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF=<span class="number">522133279</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXP=<span class="number">12000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> nset[MAXN*<span class="number">2</span>],nc=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Get</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> lower_bound(nset+<span class="number">1</span>,nset+nc,x)-nset;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> T[MAXN];<span class="keyword">int</span> N,Q;</span><br><span class="line"><span class="keyword">int</span> e[MAXN*<span class="number">2</span>],pre[MAXN*<span class="number">2</span>],id[MAXN],ec=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">l2</span><span class="params">(<span class="keyword">int</span> x)</span><span class="comment">//log x 取下整</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>((<span class="number">1</span>&lt;&lt;i)&lt;=x)</span><br><span class="line">		++i;</span><br><span class="line">	<span class="keyword">return</span> i<span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">adde</span><span class="params">(<span class="keyword">int</span> _f,<span class="keyword">int</span> <span class="keyword">_t</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	e[++ec]=<span class="keyword">_t</span>;pre[ec]=id[_f];id[_f]=ec;</span><br><span class="line">	e[++ec]=_f;pre[ec]=id[<span class="keyword">_t</span>];id[<span class="keyword">_t</span>]=ec;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> dfs[MAXN],dep[MAXN],dc=<span class="number">0</span>,lin[MAXN],rout[MAXN],fa[MAXN];<span class="comment">//BIT用</span></span><br><span class="line"><span class="keyword">int</span> mdfs[MAXN*<span class="number">2</span>],ml[MAXN],mr[MAXN],mdc=<span class="number">0</span>;<span class="comment">//ST用</span></span><br><span class="line">	<span class="comment">//每条边访问一次,而每访问一条边加入2个点 所以总共是2n级别的</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DFS</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> d)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	dep[pos]=++d;</span><br><span class="line">	dfs[++dc]=pos;</span><br><span class="line">	mdfs[++mdc]=pos;</span><br><span class="line">	lin[pos]=rout[pos]=dc;</span><br><span class="line">	ml[pos]=mr[pos]=mdc;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=id[pos];i;i=pre[i])</span><br><span class="line">		<span class="keyword">if</span>(fa[pos]!=e[i])</span><br><span class="line">		&#123;</span><br><span class="line">			fa[e[i]]=pos;</span><br><span class="line">			DFS(e[i],d);</span><br><span class="line">			rout[pos]=max(rout[pos],rout[e[i]]);		</span><br><span class="line">			mdfs[++mdc]=pos;</span><br><span class="line">			mr[pos]=max(mr[pos],mdc);</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> f[MAXN*<span class="number">2</span>][<span class="number">20</span>];<span class="comment">//i到i+(2^j)-1 [i开始长度为2^j]的最浅点</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">outst</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;=l2(mdc);j++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"2^%d:"</span>,j);</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=mdc;i++)</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"%d-%d  "</span>,i,f[i][j]);</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ST</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">//dfs</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=mdc;i++)</span><br><span class="line">		f[i][<span class="number">0</span>]=mdfs[i];</span><br><span class="line">	<span class="keyword">int</span> endj=l2(mdc),endi,pl,pr,t;	</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=endj;j++)</span><br><span class="line">	&#123;</span><br><span class="line">		endi=mdc-(<span class="number">1</span>&lt;&lt;j)+<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=endi;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			pl=f[i][j<span class="number">-1</span>];</span><br><span class="line">			pr=f[i+(<span class="number">1</span>&lt;&lt;j)-(<span class="number">1</span>&lt;&lt;j&gt;&gt;<span class="number">1</span>)][j<span class="number">-1</span>];</span><br><span class="line">			f[i][j]=dep[pl]&lt;dep[pr]?pl:pr;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LCA</span><span class="params">(<span class="keyword">int</span> p1,<span class="keyword">int</span> p2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	p1=ml[p1],p2=ml[p2];</span><br><span class="line">	<span class="keyword">if</span>(p1&gt;p2) swap(p1,p2);</span><br><span class="line">	<span class="keyword">int</span> j=l2(p2-p1+<span class="number">1</span>),ans=<span class="number">-1</span>;</span><br><span class="line">	p1=f[p1][j],p2=f[p2-(<span class="number">1</span>&lt;&lt;j)+<span class="number">1</span>][j];</span><br><span class="line">	<span class="keyword">return</span> dep[p1]&gt;dep[p2]?p2:p1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> inp[MAXN][<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SegNode</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">int</span> son[<span class="number">2</span>],cnt;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BIT</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">int</span> root[MAXN],pc,n;</span><br><span class="line">	SegNode seg[MAXP];<span class="keyword">int</span> TL,TR;<span class="comment">//1,N</span></span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">lowbit</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;<span class="keyword">return</span> x&amp;(-x);&#125;</span><br><span class="line">	BIT()&#123;pc=<span class="number">0</span>;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">valup</span><span class="params">(<span class="keyword">int</span> pos)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		seg[pos].cnt=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(S(pos,<span class="number">0</span>)) seg[pos].cnt+=seg[S(pos,<span class="number">0</span>)].cnt;</span><br><span class="line">		<span class="keyword">if</span>(S(pos,<span class="number">1</span>)) seg[pos].cnt+=seg[S(pos,<span class="number">1</span>)].cnt;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">Acs</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> L,<span class="keyword">int</span> R,<span class="keyword">int</span> l,<span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!pos)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(L==l &amp;&amp; R==r)</span><br><span class="line">			<span class="keyword">return</span> seg[pos].cnt;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">int</span> MID=(L+R)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(r&lt;=MID)</span><br><span class="line">				<span class="keyword">return</span> Acs(S(pos,<span class="number">0</span>),L,MID,l,r);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(MID+<span class="number">1</span>&lt;=l)</span><br><span class="line">				<span class="keyword">return</span> Acs(S(pos,<span class="number">1</span>),MID+<span class="number">1</span>,R,l,r);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="keyword">return</span> Acs(S(pos,<span class="number">0</span>),L,MID,l,MID)+Acs(S(pos,<span class="number">1</span>),MID+<span class="number">1</span>,R,MID+<span class="number">1</span>,r);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">Edit</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> L,<span class="keyword">int</span> R,<span class="keyword">int</span> goal,<span class="keyword">int</span> v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">int</span> pres=pos?pos:++pc;</span><br><span class="line">		seg[pres]=seg[pos];</span><br><span class="line">		<span class="keyword">if</span>(L==R)</span><br><span class="line">			seg[pres].cnt+=v;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">int</span> MID=(L+R)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(goal&lt;=MID)</span><br><span class="line">				S(pres,<span class="number">0</span>)=Edit(S(pos,<span class="number">0</span>),L,MID,goal,v);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				S(pres,<span class="number">1</span>)=Edit(S(pos,<span class="number">1</span>),MID+<span class="number">1</span>,R,goal,v);</span><br><span class="line">			valup(pres);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> pres;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">Sum</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> l,<span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function">	<span class="comment">//得到树上pos位置的线段树[l,r]区间的cnt</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!pos)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">int</span> ans=<span class="number">0</span>;</span><br><span class="line">		pos=lin[pos];</span><br><span class="line">		<span class="keyword">for</span>(;pos;pos-=lowbit(pos))	</span><br><span class="line">			ans+=Acs(root[pos],TL,TR,l,r);</span><br><span class="line">		<span class="keyword">return</span> ans;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> goal,<span class="keyword">int</span> v)</span></span></span><br><span class="line"><span class="function">	<span class="comment">//修改dfs序列中的pos对应的树</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(;pos&lt;=n;pos+=lowbit(pos))</span><br><span class="line">			root[pos]=Edit(root[pos],TL,TR,goal,v);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">Add</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> goal,<span class="keyword">int</span> v)</span></span></span><br><span class="line"><span class="function">	<span class="comment">//修改pos(树上编号)应的子树的区间</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		add(lin[pos],goal,v);</span><br><span class="line">		<span class="keyword">if</span>(rout[pos]&lt;n)</span><br><span class="line">			add(rout[pos]+<span class="number">1</span>,goal,-v);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">Que</span><span class="params">(<span class="keyword">int</span> p1,<span class="keyword">int</span> p2,<span class="keyword">int</span> K)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">int</span> lca=LCA(p1,p2);</span><br><span class="line">		K=dep[p1]+dep[p2]-dep[lca]*<span class="number">2</span>+<span class="number">1</span>-K+<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span>(K&lt;=<span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> -INF;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> L=TL,R=TR,MID=(L+R)&gt;&gt;<span class="number">1</span>,sum;</span><br><span class="line">		<span class="comment">//int s1,s2,s3;	</span></span><br><span class="line">		<span class="keyword">while</span>(K)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(L==R)</span><br><span class="line">			&#123;</span><br><span class="line">					<span class="keyword">return</span> nset[L];</span><br><span class="line">			&#125;</span><br><span class="line">			MID=(L+R)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			sum=Sum(p1,L,MID)+Sum(p2,L,MID)-Sum(lca,L,MID)-Sum(fa[lca],L,MID);</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(sum&lt;K)</span><br><span class="line">			&#123;</span><br><span class="line">				K-=sum;</span><br><span class="line">				L=MID+<span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> R=MID;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> INF;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Out</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;i++)</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"%d "</span>,Sum(i,TL,TR));</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OutS</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;i++)</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"%d "</span>,Acs(root[i],TL,TR,TL,TR));</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;B;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InitSeg</span><span class="params">(<span class="keyword">int</span> pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	B.Add(pos,Get(T[pos]),<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=id[pos];i;i=pre[i])</span><br><span class="line">		<span class="keyword">if</span>(e[i]!=fa[pos])</span><br><span class="line">			InitSeg(e[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//freopen("input.txt","r",stdin);</span></span><br><span class="line">	<span class="comment">//freopen("output.txt","w",stdout);</span></span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;N,&amp;Q);</span><br><span class="line">	B.n=N;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=N;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;T[i]);</span><br><span class="line">		nset[++nc]=T[i];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> t1,t2,t3;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=N<span class="number">-1</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;t1,&amp;t2);</span><br><span class="line">		adde(t1,t2);</span><br><span class="line">	&#125;</span><br><span class="line">	DFS(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">	dep[<span class="number">0</span>]=INF;</span><br><span class="line">	ST();</span><br><span class="line">	<span class="keyword">int</span> *p;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=Q;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		p=inp[i];</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">"%d%d%d"</span>,&amp;p[<span class="number">0</span>],&amp;p[<span class="number">1</span>],&amp;p[<span class="number">2</span>]);</span><br><span class="line">		<span class="keyword">if</span>(!p[<span class="number">0</span>])</span><br><span class="line">			nset[++nc]=p[<span class="number">2</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	sort(nset+<span class="number">1</span>,nset+<span class="number">1</span>+nc);</span><br><span class="line">	nc=unique(nset+<span class="number">1</span>,nset+<span class="number">1</span>+nc)-nset<span class="number">-1</span>;</span><br><span class="line">	B.TL=<span class="number">1</span>,B.TR=nc;</span><br><span class="line">	InitSeg(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=Q;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		p=inp[i];</span><br><span class="line">		<span class="keyword">if</span>(!p[<span class="number">0</span>])</span><br><span class="line">		&#123;</span><br><span class="line">			B.Add(p[<span class="number">1</span>],Get(T[p[<span class="number">1</span>]]),<span class="number">-1</span>);</span><br><span class="line">			B.Add(p[<span class="number">1</span>],Get(p[<span class="number">2</span>]),<span class="number">1</span>);</span><br><span class="line">			T[p[<span class="number">1</span>]]=p[<span class="number">2</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			t1=B.Que(p[<span class="number">1</span>],p[<span class="number">2</span>],p[<span class="number">0</span>]);</span><br><span class="line">			<span class="keyword">if</span>(t1!=-INF)</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,t1);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">"invalid request!"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="线段树套平衡树维护括号序列"><a href="#线段树套平衡树维护括号序列" class="headerlink" title="线段树套平衡树维护括号序列"></a>线段树套平衡树维护括号序列</h1><h2 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution"></a>Solution</h2><p>现在考虑优化的话，主要就是要考虑压缩空间，否则太不友好。注意到，空间之所以那么大，是因为把主席树建在了内层，一个点的权值可能出现在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>log</mi><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>棵线段树中，出现一次就至多带来<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>log</mi><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>个节点，比较浪费。
那么考虑把值域线段树建在外层，那么这一部分的空间就是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>。考虑如何在内层维护整个树。
用DFS序列应该就不好弄了。。涉及到路径，DFS序似乎就无力了。。。
于是祭出大杀器：括号序！
一个树的括号序，指的是每个点在进栈的时候放一个左括号，出栈的时候放一个右括号。
然后把一棵树的括号序写下来，会发现一个惊天大秘密：从第一个括号开始，到<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">pos</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span></span></span></span>的左括号，把匹配的括号删掉，恰好可以得到从根节点到<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">pos</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span></span></span></span>的路径！
于是就可做了：
在值域线段树的每个节点<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span>挂一个平衡树，平衡树维护所有值被<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span>覆盖的点的左括号位置和右括号位置。左括号的权值为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span></span></span></span>，右括号为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord">−</span><span class="mord mathrm">1</span></span></span></span>，这样做一下前缀和，就可以得到根节点到一个点的路径上有多少点的值在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span>之内了！然后就可以做了。
空间复杂度<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><mi>log</mi><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n \log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>。</p>
<h2 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lucida"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::swap;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::sort;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::lower_bound;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::unique;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN=<span class="number">80000</span>+<span class="number">11</span>,INF=<span class="number">0x1f1f1f1f</span>,MAXLOG=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">int</span> n,w[MAXN],nums[MAXN&lt;&lt;<span class="number">1</span>],nc=<span class="number">0</span>,dep[MAXN];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> alloc(T,c) (T*)malloc((c)*sizeof(T))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ref(x) (lower_bound(nums+1,nums+1+nc,(x))-nums)</span></span><br><span class="line"><span class="keyword">namespace</span> treap &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Node</span> *<span class="title">null</span>,**<span class="title">rec</span>,*<span class="title">Me</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> P=<span class="number">99929</span>,SIZE=(MAXN&lt;&lt;<span class="number">1</span>)*MAXLOG;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">		Node *son[<span class="number">2</span>];</span><br><span class="line">		<span class="keyword">int</span> val,cnt,sz,py;</span><br><span class="line">		Node():sz(<span class="number">0</span>),py(P) &#123;</span><br><span class="line">			son[<span class="number">0</span>]=son[<span class="number">1</span>]=<span class="number">0</span>;</span><br><span class="line">			val=-INF;</span><br><span class="line">		&#125;</span><br><span class="line">		Node(<span class="keyword">int</span> val,<span class="keyword">int</span> cnt):val(val),cnt(cnt),sz(cnt),py(rand()%P) &#123;</span><br><span class="line">			son[<span class="number">0</span>]=son[<span class="number">1</span>]=null;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Up</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			sz=son[<span class="number">0</span>]-&gt;sz+son[<span class="number">1</span>]-&gt;sz+cnt;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> *<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span>)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> *rec?*rec--:Me++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="keyword">void</span> *p)</span> </span>&#123;</span><br><span class="line">			*++rec=(Node*)p;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;**cer=rec=alloc(Node*,SIZE),*eM=Me=alloc(Node,SIZE),*llun=null=<span class="keyword">new</span> Node;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Treap</span> &#123;</span></span><br><span class="line">		Node *root;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Trans</span><span class="params">(Node *&amp;pos,<span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">			Node *s=pos-&gt;son[d];</span><br><span class="line">			pos-&gt;son[d]=s-&gt;son[!d];</span><br><span class="line">			s-&gt;son[!d]=pos;</span><br><span class="line">			pos-&gt;Up();</span><br><span class="line">			(pos=s)-&gt;Up();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">int</span> <span class="title">Adjust</span><span class="params">(Node *&amp;pos)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">int</span> d=pos-&gt;son[<span class="number">0</span>]-&gt;py&gt;pos-&gt;son[<span class="number">1</span>]-&gt;py;</span><br><span class="line">			<span class="keyword">return</span> pos-&gt;py&gt;pos-&gt;son[d]-&gt;py?(Trans(pos,d),!d):<span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Fall</span><span class="params">(Node *&amp;pos)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">int</span> d=Adjust(pos);</span><br><span class="line">			<span class="keyword">if</span>(d==<span class="number">-1</span>) &#123;</span><br><span class="line">				<span class="keyword">delete</span> pos;</span><br><span class="line">				pos=null;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				Fall(pos-&gt;son[d]);</span><br><span class="line">				pos-&gt;Up();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Delete</span><span class="params">(Node *&amp;pos,<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(pos-&gt;val==val) &#123;</span><br><span class="line">				pos-&gt;py=P;</span><br><span class="line">				Fall(pos);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				Delete(pos-&gt;son[pos-&gt;val&lt;val],val);</span><br><span class="line">				pos-&gt;Up();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(Node *&amp;pos,Node *goal)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(pos==null)</span><br><span class="line">				pos=goal;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				Insert(pos-&gt;son[pos-&gt;val&lt;goal-&gt;val],goal);</span><br><span class="line">				pos-&gt;Up();<span class="comment">//adjust不一定会adjust啊...</span></span><br><span class="line">				Adjust(pos);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">typedef</span> Node *Iter;		</span><br><span class="line">		Treap():root(null)&#123;&#125;</span><br><span class="line">		<span class="function"><span class="keyword">int</span> <span class="title">Rank</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">			Node *pos=root;<span class="keyword">int</span> res=<span class="number">0</span>;</span><br><span class="line">			<span class="keyword">while</span>(pos!=null) &#123;</span><br><span class="line">				<span class="keyword">if</span>(pos-&gt;val&lt;=v) &#123;</span><br><span class="line">					res+=pos-&gt;son[<span class="number">0</span>]-&gt;sz+pos-&gt;cnt;</span><br><span class="line">					pos=pos-&gt;son[<span class="number">1</span>];</span><br><span class="line">				&#125; <span class="keyword">else</span></span><br><span class="line">					pos=pos-&gt;son[<span class="number">0</span>];</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> res;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Delete</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">			Delete(root,val);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">int</span> val,<span class="keyword">int</span> cnt)</span> </span>&#123;</span><br><span class="line">			Insert(root,<span class="keyword">new</span> Node(val,cnt));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;<span class="keyword">using</span> treap::Treap;</span><br><span class="line"><span class="keyword">namespace</span> segtree &#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> SIZE=MAXN&lt;&lt;<span class="number">2</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">		Node *son[<span class="number">2</span>];</span><br><span class="line">		Treap idx;</span><br><span class="line">		Node() &#123;</span><br><span class="line">			son[<span class="number">0</span>]=son[<span class="number">1</span>]=<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> *<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span>)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">static</span> Node *Pool=alloc(Node,SIZE);</span><br><span class="line">			<span class="keyword">return</span> Pool++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">SegTree</span> &#123;</span></span><br><span class="line">		<span class="keyword">typedef</span> Node *Iter;</span><br><span class="line">		Node *root;</span><br><span class="line">		<span class="keyword">int</span> L,R;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Build</span><span class="params">(Node *&amp;pos,<span class="keyword">int</span> L,<span class="keyword">int</span> R)</span> </span>&#123;</span><br><span class="line">			pos=<span class="keyword">new</span> Node;</span><br><span class="line">			<span class="keyword">if</span>(L!=R) &#123;</span><br><span class="line">				<span class="keyword">int</span> Mid=(L+R)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">				Build(pos-&gt;son[<span class="number">0</span>],L,Mid);</span><br><span class="line">				Build(pos-&gt;son[<span class="number">1</span>],Mid+<span class="number">1</span>,R);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Point</span><span class="params">(Node *pos,<span class="keyword">int</span> L,<span class="keyword">int</span> R,<span class="keyword">int</span> goal,<span class="keyword">int</span> v,<span class="keyword">int</span> cnt)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(v&gt;<span class="number">0</span>) pos-&gt;idx.Insert(v,cnt);</span><br><span class="line">			<span class="keyword">else</span> pos-&gt;idx.Delete(-v);</span><br><span class="line">			<span class="keyword">if</span>(L!=R) &#123;</span><br><span class="line">				<span class="keyword">int</span> Mid=(L+R)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">				<span class="keyword">if</span>(goal&lt;=Mid)</span><br><span class="line">					Point(pos-&gt;son[<span class="number">0</span>],L,Mid,goal,v,cnt);</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					Point(pos-&gt;son[<span class="number">1</span>],Mid+<span class="number">1</span>,R,goal,v,cnt);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		SegTree()&#123;&#125;</span><br><span class="line">		SegTree(<span class="keyword">int</span> L,<span class="keyword">int</span> R):L(L),R(R) &#123;</span><br><span class="line">			Build(root,L,R);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> idx,<span class="keyword">int</span> cnt)</span> </span>&#123;</span><br><span class="line">			Point(root,L,R,pos,idx,cnt);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">Delete</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">			Point(root,L,R,pos,-idx,<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;<span class="keyword">using</span> segtree::SegTree;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> to;Edge *pre;</span><br><span class="line">	Edge(<span class="keyword">int</span> to,Edge *pre):to(to),pre(pre)&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> *<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span>)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">static</span> Edge *Me=alloc(Edge,MAXN&lt;&lt;<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">return</span> Me++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;*G[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Adde</span><span class="params">(<span class="keyword">int</span> f,<span class="keyword">int</span> t)</span> </span>&#123;</span><br><span class="line">	G[f]=<span class="keyword">new</span> Edge(t,G[f]);</span><br><span class="line">	G[t]=<span class="keyword">new</span> Edge(f,G[t]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> _ST_ &#123;</span><br><span class="line">	<span class="keyword">int</span> mdfs[MAXN&lt;&lt;<span class="number">1</span>],lbd[MAXN],rbd[MAXN],mdc,log_2[MAXN&lt;&lt;<span class="number">1</span>],f[MAXLOG][MAXN&lt;&lt;<span class="number">1</span>];</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ST</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		log_2[<span class="number">0</span>]=<span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=mdc;++i) &#123;</span><br><span class="line">			f[<span class="number">0</span>][i]=mdfs[i];</span><br><span class="line">			log_2[i]=log_2[i&gt;&gt;<span class="number">1</span>]+<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> lg=<span class="number">1</span>,elg=log_2[mdc];lg&lt;=elg;++lg)</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> pl,pr,i=<span class="number">1</span>,ei=mdc-(<span class="number">1</span>&lt;&lt;lg)+<span class="number">1</span>;i&lt;=ei;++i)</span><br><span class="line">				f[lg][i]=dep[pl=f[lg<span class="number">-1</span>][i]]&lt;dep[pr=f[lg<span class="number">-1</span>][i+(<span class="number">1</span>&lt;&lt;lg&gt;&gt;<span class="number">1</span>)]]?pl:pr;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">LCA</span><span class="params">(<span class="keyword">int</span> p1,<span class="keyword">int</span> p2)</span> </span>&#123;</span><br><span class="line">		p1=lbd[p1],p2=lbd[p2];</span><br><span class="line">		<span class="keyword">if</span>(p1&gt;p2) swap(p1,p2);</span><br><span class="line">		<span class="keyword">int</span> lg=log_2[p2-p1+<span class="number">1</span>],pl,pr;</span><br><span class="line">		<span class="keyword">return</span> dep[pl=f[lg][p1]]&lt;dep[pr=f[lg][p2-(<span class="number">1</span>&lt;&lt;lg)+<span class="number">1</span>]]?pl:pr;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">using</span> _ST_::LCA;</span><br><span class="line"><span class="keyword">int</span> dfs[MAXN&lt;&lt;<span class="number">1</span>],dc,lpt[MAXN],rpt[MAXN],fa[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DFS</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">using</span> <span class="keyword">namespace</span> _ST_;</span><br><span class="line">	dfs[++dc]=pos;lpt[pos]=dc;</span><br><span class="line">	mdfs[++mdc]=pos;lbd[pos]=mdc;</span><br><span class="line">	<span class="keyword">for</span>(Edge *e=G[pos];e;e=e-&gt;pre)</span><br><span class="line">		<span class="keyword">if</span>(e-&gt;to!=fa[pos]) &#123;</span><br><span class="line">			fa[e-&gt;to]=pos;</span><br><span class="line">			dep[e-&gt;to]=dep[pos]+<span class="number">1</span>;</span><br><span class="line">			DFS(e-&gt;to);</span><br><span class="line">			mdfs[++mdc]=pos;</span><br><span class="line">		&#125;</span><br><span class="line">	dfs[++dc]=pos;rpt[pos]=dc;</span><br><span class="line">	rbd[pos]=mdc;</span><br><span class="line">&#125;</span><br><span class="line">SegTree seg;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	DFS(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">new</span>(&amp;seg) SegTree(<span class="number">1</span>,nc);</span><br><span class="line">	_ST_::ST();</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i) &#123;</span><br><span class="line">		seg.Insert(w[i],lpt[i],<span class="number">1</span>);</span><br><span class="line">		seg.Insert(w[i],rpt[i],<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Query</span><span class="params">(<span class="keyword">int</span> p1,<span class="keyword">int</span> p2,<span class="keyword">int</span> K)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> lca=LCA(p1,p2);</span><br><span class="line">	K=dep[p1]+dep[p2]-dep[lca]*<span class="number">2</span>+<span class="number">1</span>-K+<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(K&lt;=<span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">int</span> L=<span class="number">1</span>,R=nc;</span><br><span class="line">		SegTree::Iter pos=seg.root;</span><br><span class="line">		<span class="keyword">while</span>(L!=R) &#123;</span><br><span class="line">			<span class="keyword">int</span> Mid=(L+R)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			Treap &amp;idx=pos-&gt;son[<span class="number">0</span>]-&gt;idx;</span><br><span class="line">			<span class="keyword">int</span> d=idx.Rank(lpt[p1])+idx.Rank(lpt[p2])-idx.Rank(lpt[lca])-idx.Rank(lpt[fa[lca]]);</span><br><span class="line">			<span class="keyword">if</span>(K&lt;=d) &#123;</span><br><span class="line">				R=Mid;</span><br><span class="line">				pos=pos-&gt;son[<span class="number">0</span>];</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				K-=d;</span><br><span class="line">				L=Mid+<span class="number">1</span>;</span><br><span class="line">				pos=pos-&gt;son[<span class="number">1</span>];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> L;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">23333</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Change</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> newv)</span> </span>&#123;</span><br><span class="line">	seg.Delete(w[pos],lpt[pos]);</span><br><span class="line">	seg.Delete(w[pos],rpt[pos]);</span><br><span class="line">	w[pos]=newv;</span><br><span class="line">	seg.Insert(w[pos],lpt[pos],<span class="number">1</span>);</span><br><span class="line">	seg.Insert(w[pos],rpt[pos],<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	freopen(<span class="string">"input"</span>,<span class="string">"r"</span>,<span class="built_in">stdin</span>);</span><br><span class="line">	srand(<span class="number">0x1f1f1f1f</span>);</span><br><span class="line">	<span class="keyword">int</span> Q;is&gt;&gt;n&gt;&gt;Q;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i) &#123;</span><br><span class="line">		is&gt;&gt;w[i];</span><br><span class="line">		nums[++nc]=w[i];<span class="comment">//=i?????????w[i]????</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n<span class="number">-1</span>;++i) &#123;</span><br><span class="line">		<span class="keyword">int</span> x,y;</span><br><span class="line">		is&gt;&gt;x&gt;&gt;y;</span><br><span class="line">		Adde(x,y);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span><span class="keyword">int</span> k,a,b;&#125;opt[MAXN];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=Q;++i) &#123;</span><br><span class="line">		is&gt;&gt;opt[i].k&gt;&gt;opt[i].a&gt;&gt;opt[i].b;</span><br><span class="line">		<span class="keyword">if</span>(!opt[i].k)</span><br><span class="line">			nums[++nc]=opt[i].b;</span><br><span class="line">	&#125;</span><br><span class="line">	sort(nums+<span class="number">1</span>,nums+<span class="number">1</span>+nc);</span><br><span class="line">	nc=unique(nums+<span class="number">1</span>,nums+<span class="number">1</span>+nc)-nums<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i)</span><br><span class="line">		w[i]=ref(w[i]);</span><br><span class="line">	Build();</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=Q;++i)</span><br><span class="line">		<span class="keyword">if</span>(opt[i].k) &#123;</span><br><span class="line">			<span class="keyword">int</span> Ans=Query(opt[i].a,opt[i].b,opt[i].k);</span><br><span class="line">			<span class="keyword">if</span>(Ans) os&lt;&lt;nums[Ans]&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">			<span class="keyword">else</span> os&lt;&lt;<span class="string">"invalid request!"</span>&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			Change(opt[i].a,ref(opt[i].b));</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lucida.site/BZOJ1758/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lucida">
      <meta itemprop="description" content="It's been a while.">
      <meta itemprop="image" content="/images/luz.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hey,Lucida is back.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/BZOJ1758/" itemprop="url">
                  BZOJ 1758 重建计划
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-13 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-13T00:00:00+08:00">2017-03-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-18 18:23:51" itemprop="dateModified" datetime="2018-06-18T18:23:51+08:00">2018-06-18</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Link"><a href="#Link" class="headerlink" title="Link"></a><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=1758" target="_blank" rel="noopener">Link</a></h1><p>被POI的智商题虐惨了，写几道数据结构<del>颐养身心</del></p>
<h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><p>就是普普通通的一个套了二分的点分治。
然而大部分人的做法都被hack了。
考虑一道最典型的点分治：楼教主男人八题Tree
我写的做法是在每层点分治，对每个子树双指针+归并。
极端情况：一个点，一个子树有<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mi>n</mi><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">\dfrac n2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.10756em;"></span><span class="strut bottom" style="height:1.7935600000000003em;vertical-align:-0.686em;"></span><span class="base textstyle uncramped"><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord mathrm">2</span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord mathit">n</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span>个点，剩下的是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mi>n</mi><mn>2</mn></mfrac><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\dfrac n2-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.10756em;"></span><span class="strut bottom" style="height:1.7935600000000003em;vertical-align:-0.686em;"></span><span class="base textstyle uncramped"><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord mathrm">2</span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord mathit">n</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">−</span><span class="mord mathrm">1</span></span></span></span>个一个点的子树。而且，链上点的权值都比剩下的一堆点小。那么归并的总复杂度就是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mfrac><mrow><msup><mi>n</mi><mn>2</mn></msup></mrow><mn>4</mn></mfrac><mo>)</mo></mrow><annotation encoding="application/x-tex">O(\dfrac {n^2}4)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.491108em;"></span><span class="strut bottom" style="height:2.177108em;vertical-align:-0.686em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord mathrm">4</span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit">n</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mclose">)</span></span></span></span>。所以，这种依赖于线性扫描的点分治，一定要先把子节点按照大小/深度排序。</p>
<h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lucida"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::max;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::min;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::fill;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::sort;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN=<span class="number">100000</span>+<span class="number">11</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> eps=<span class="number">1e-4</span>,inf=<span class="number">1e11</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> to,v;</span><br><span class="line">	Edge *pre;</span><br><span class="line">	Edge()&#123;&#125;</span><br><span class="line">	Edge(<span class="keyword">int</span> to,<span class="keyword">int</span> v,Edge *pre):to(to),v(v),pre(pre)&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> *<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span>)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">static</span> Edge *Pool=(Edge*)<span class="built_in">malloc</span>((MAXN&lt;&lt;<span class="number">1</span>)*<span class="keyword">sizeof</span>(Edge)),*Me=Pool;</span><br><span class="line">		<span class="keyword">return</span> Me++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;*G[MAXN];</span><br><span class="line"><span class="keyword">int</span> deg[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Adde</span><span class="params">(<span class="keyword">int</span> f,<span class="keyword">int</span> t,<span class="keyword">int</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	deg[f]++,deg[t]++;</span><br><span class="line">	G[f]=<span class="keyword">new</span> Edge(t,v,G[f]);</span><br><span class="line">	G[t]=<span class="keyword">new</span> Edge(f,v,G[t]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> lbd,ubd,n;</span><br><span class="line"><span class="keyword">double</span> ratio;</span><br><span class="line"><span class="keyword">namespace</span> _DC_ &#123;</span><br><span class="line">	<span class="keyword">int</span> sz[MAXN],dist[MAXN],tol,f[MAXN];</span><br><span class="line">	<span class="keyword">bool</span> ud[MAXN];</span><br><span class="line">	<span class="keyword">double</span> amx[MAXN],smx[MAXN];</span><br><span class="line">	<span class="keyword">int</span> alen,slen;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">GetSize</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> fa)</span> </span>&#123;</span><br><span class="line">		sz[pos]=<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span>(Edge *e=G[pos];e;e=e-&gt;pre)</span><br><span class="line">			<span class="keyword">if</span>(e-&gt;to!=fa &amp;&amp; !ud[e-&gt;to]) &#123;</span><br><span class="line">				<span class="keyword">int</span> u=e-&gt;to;</span><br><span class="line">				GetSize(u,pos);</span><br><span class="line">				sz[pos]+=sz[u];</span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">DP</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> fa)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> mxsize=<span class="number">0</span>,res=<span class="number">0</span>;</span><br><span class="line">		f[pos]=tol-sz[pos];</span><br><span class="line">		<span class="keyword">for</span>(Edge *e=G[pos];e;e=e-&gt;pre)</span><br><span class="line">			<span class="keyword">if</span>(e-&gt;to!=fa &amp;&amp; !ud[e-&gt;to]) &#123;</span><br><span class="line">				<span class="keyword">int</span> u=e-&gt;to;</span><br><span class="line">				<span class="keyword">int</span> temp=DP(u,pos);</span><br><span class="line">				res=(res==<span class="number">0</span> || f[res]&gt;f[temp])?temp:res;</span><br><span class="line">				chkmx(mxsize,sz[u]);</span><br><span class="line">			&#125;</span><br><span class="line">		chkmx(f[pos],mxsize);</span><br><span class="line">		<span class="keyword">return</span> (res==<span class="number">0</span> || f[res]&gt;f[pos])?pos:res;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">GC</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">		tol=sz[pos];</span><br><span class="line">		<span class="keyword">return</span> tol&lt;lbd?<span class="number">-1</span>:DP(pos,<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">Calc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=lbd,endi=min(ubd,slen);i&lt;=endi;++i)</span><br><span class="line">			<span class="keyword">if</span>(smx[i]&gt;=<span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">static</span> <span class="keyword">int</span> Q[MAXN],he,ta;</span><br><span class="line">		he=<span class="number">1</span>,ta=<span class="number">0</span>;</span><br><span class="line">		<span class="comment">//枚举在左边取长度为i的部分</span></span><br><span class="line">		<span class="comment">//右边取[lbd-i,min(ubd-i,slen)]</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=min(alen,ubd<span class="number">-1</span>),p=<span class="number">0</span>;i&gt;=<span class="number">1</span> &amp;&amp; lbd&lt;=slen+i;--i) &#123;</span><br><span class="line">			<span class="keyword">while</span>(p+<span class="number">1</span>&lt;=min(ubd-i,slen)) &#123; </span><br><span class="line">				++p;</span><br><span class="line">				<span class="keyword">while</span>(he&lt;=ta &amp;&amp; smx[p]&gt;smx[Q[ta]])</span><br><span class="line">					ta--;</span><br><span class="line">				Q[++ta]=p;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">while</span>(Q[he]&lt;lbd-i)	</span><br><span class="line">				he++,assert(he&lt;=ta);</span><br><span class="line">			<span class="keyword">if</span>(amx[i]+smx[Q[he]]&gt;=<span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=slen;++i) &#123;</span><br><span class="line">			amx[i]=i&gt;alen?-inf:amx[i];</span><br><span class="line">			chkmx(amx[i],smx[i]);</span><br><span class="line">			smx[i]=-inf;</span><br><span class="line">		&#125;</span><br><span class="line">		chkmx(alen,slen);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">DFS</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> fa,<span class="keyword">int</span> dep,<span class="keyword">double</span> sumv,<span class="keyword">double</span> ratio)</span> </span>&#123;</span><br><span class="line">		smx[dep]=chkmx(slen,dep)?-inf:smx[dep];</span><br><span class="line">		chkmx(smx[dep],sumv);</span><br><span class="line">		<span class="keyword">int</span> dist=dep;</span><br><span class="line">		<span class="keyword">for</span>(Edge *e=G[pos];e;e=e-&gt;pre)</span><br><span class="line">			<span class="keyword">if</span>(e-&gt;to!=fa &amp;&amp; !ud[e-&gt;to]) &#123;</span><br><span class="line">				<span class="keyword">int</span> u=e-&gt;to;</span><br><span class="line">				chkmx(dist,DFS(u,pos,dep+<span class="number">1</span>,e-&gt;v-ratio+sumv,ratio));</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">return</span> dist;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">Go</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> fa)</span> </span>&#123;</span><br><span class="line">		dist[pos]=<span class="number">0</span>;</span><br><span class="line">		sz[pos]=<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">int</span> res=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(Edge *e=G[pos];e;e=e-&gt;pre)</span><br><span class="line">			<span class="keyword">if</span>(e-&gt;to!=fa &amp;&amp; !ud[e-&gt;to]) &#123;</span><br><span class="line">				<span class="keyword">int</span> u=e-&gt;to;</span><br><span class="line">				chkmx(res,max(e-&gt;v,Go(u,pos)));</span><br><span class="line">				chkmx(dist[pos],dist[u]);</span><br><span class="line">				sz[pos]+=sz[u];</span><br><span class="line">			&#125;</span><br><span class="line">		++dist[pos];</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">cmpDist</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> &amp;x,<span class="keyword">const</span> <span class="keyword">int</span> &amp;y)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> dist[x]&lt;dist[y];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">double</span> <span class="title">DC</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">double</span> preAns)</span> </span>&#123;</span><br><span class="line">		pos=GC(pos);</span><br><span class="line">		<span class="keyword">if</span>(pos==<span class="number">-1</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		ud[pos]=<span class="number">1</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">static</span> <span class="keyword">int</span> son[MAXN],vtf[MAXN];</span><br><span class="line">		<span class="keyword">int</span> sc=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">double</span> L=preAns,R=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(Edge *e=G[pos];e;e=e-&gt;pre)</span><br><span class="line">			<span class="keyword">if</span>(!ud[e-&gt;to]) &#123;</span><br><span class="line">				chkmx(R,(<span class="keyword">double</span>)max(e-&gt;v,Go(son[++sc]=e-&gt;to,<span class="number">0</span>)));</span><br><span class="line">				vtf[e-&gt;to]=e-&gt;v;</span><br><span class="line">			&#125;</span><br><span class="line">		sort(son+<span class="number">1</span>,son+<span class="number">1</span>+sc,cmpDist);</span><br><span class="line">		<span class="keyword">while</span>(R-L&gt;eps) &#123;</span><br><span class="line">			<span class="keyword">bool</span> tak=<span class="number">0</span>;</span><br><span class="line">			<span class="keyword">double</span> Mid=(L+R)/<span class="number">2</span>;</span><br><span class="line">			alen=slen=<span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=sc;++i) &#123;</span><br><span class="line">				<span class="keyword">int</span> u=son[i];</span><br><span class="line">				slen=DFS(u,<span class="number">0</span>,<span class="number">1</span>,vtf[u]-Mid,Mid);</span><br><span class="line">				<span class="keyword">if</span>(Calc()) &#123;</span><br><span class="line">					tak=<span class="number">1</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(tak)</span><br><span class="line">				L=Mid;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				R=Mid;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">double</span> res=L;</span><br><span class="line">		<span class="keyword">for</span>(Edge *e=G[pos];e;e=e-&gt;pre)</span><br><span class="line">			<span class="keyword">if</span>(!ud[e-&gt;to])</span><br><span class="line">				chkmx(res,DC(e-&gt;to,res));</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> _DC_;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//	freopen("input","r",stdin);</span></span><br><span class="line">	is&gt;&gt;n;</span><br><span class="line">	<span class="keyword">int</span> maxv=<span class="number">0</span>;is&gt;&gt;lbd&gt;&gt;ubd;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n<span class="number">-1</span>;++i) &#123;</span><br><span class="line">		<span class="keyword">int</span> a,b,v;</span><br><span class="line">		is&gt;&gt;a&gt;&gt;b&gt;&gt;v;</span><br><span class="line">		Adde(a,b,v);</span><br><span class="line">		chkmx(maxv,v);</span><br><span class="line">	&#125;</span><br><span class="line">	GetSize(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">double</span> Ans=DC(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%.3lf\n"</span>,Ans);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lucida.site/BZOJ3828/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lucida">
      <meta itemprop="description" content="It's been a while.">
      <meta itemprop="image" content="/images/luz.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hey,Lucida is back.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/BZOJ3828/" itemprop="url">
                  BZOJ 3828 Criminal
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-12 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-12T00:00:00+08:00">2017-03-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-17 18:00:40" itemprop="dateModified" datetime="2018-06-17T18:00:40+08:00">2018-06-17</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Link"><a href="#Link" class="headerlink" title="Link"></a><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=3828" target="_blank" rel="noopener">Link</a></h1><p>对我来说算神题了</p>
<h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><p>先考虑暴力做法
枚举每个与模式串的最后一个颜色相同的点，判断是否合法。
判断方法是从这个点向两边分别贪心地匹配两个模式串，找到一个最靠右的左串匹配位置<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span></span></span></span>，和最靠左的右串匹配位置<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">r</span></span></span></span>。然后在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mn>1</mn><mo separator="true">,</mo><mi>l</mi><mo>−</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[1,l-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mbin">−</span><span class="mord mathrm">1</span><span class="mclose">]</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>r</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>n</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">[r+1,n]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mbin">+</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathit">n</span><span class="mclose">]</span></span></span></span>中找一下是否有两个颜色相同的点。至于找相同，一种方法就是遍历<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mn>1</mn><mo separator="true">,</mo><mi>l</mi><mo>−</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[1,l-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mbin">−</span><span class="mord mathrm">1</span><span class="mclose">]</span></span></span></span>，把途径的颜色用<code>bool[]</code>标记，然后再遍历<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>r</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>n</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">[r+1,n]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mbin">+</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathit">n</span><span class="mclose">]</span></span></span></span>。
可以看出，这样又做了很多无用功，因为很有可能连续的一段区间，向左右匹配的位置都是相同的。这样就不好了。
所以考虑对这个量进行预处理。然后我就怎么也想不出来了。研究一番Claris巨神的代码，并看不懂复杂度。写完A掉之后，忽然灵光一现，不禁拍案叫绝。
设原序列为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mo>[</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">c[]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mopen">[</span><span class="mclose">]</span></span></span></span>，左模式串的序列为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>[</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">x[]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">x</span><span class="mopen">[</span><span class="mclose">]</span></span></span></span>。假设当前在计算<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>s</mi><mo>[</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">ls[]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">s</span><span class="mopen">[</span><span class="mclose">]</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>s</mi><mo>[</mo><mi>i</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">ls[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">s</span><span class="mopen">[</span><span class="mord mathit">i</span><span class="mclose">]</span></span></span></span>表示使得<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mo>[</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">c[]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mopen">[</span><span class="mclose">]</span></span></span></span>的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>a</mi><mo separator="true">,</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[a,i-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathit">a</span><span class="mpunct">,</span><span class="mord mathit">i</span><span class="mbin">−</span><span class="mord mathrm">1</span><span class="mclose">]</span></span></span></span>中存在一个子序列<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>[</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">x[]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">x</span><span class="mopen">[</span><span class="mclose">]</span></span></span></span>，且最大的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">a</span></span></span></span>，设<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mi>i</mi><mi>r</mi><mi>s</mi><mi>t</mi><mo>[</mo><mi>p</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">first[p]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mopen">[</span><span class="mord mathit">p</span><span class="mclose">]</span></span></span></span>表示在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mo>[</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">c[]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mopen">[</span><span class="mclose">]</span></span></span></span>中的第一个颜色<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">p</span></span></span></span>的位置，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mi>e</mi><mi>x</mi><mi>t</mi><mo>[</mo><mi>i</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">next[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord mathit">t</span><span class="mopen">[</span><span class="mord mathit">i</span><span class="mclose">]</span></span></span></span>表示序列<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mo>[</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">c[]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mopen">[</span><span class="mclose">]</span></span></span></span>中下一个与<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mo>[</mo><mi>i</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">c[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mopen">[</span><span class="mord mathit">i</span><span class="mclose">]</span></span></span></span>颜色相同的位置。
外层循环从<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mn>1</mn><mo separator="true">,</mo><mi>n</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">[1,n]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathit">n</span><span class="mclose">]</span></span></span></span>枚举<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mo>[</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">c[]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mopen">[</span><span class="mclose">]</span></span></span></span>的每一个位置<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.65952em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span></span></span></span>，设<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mo>[</mo><mi>p</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">f[p]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathit">p</span><span class="mclose">]</span></span></span></span>表示使得<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>a</mi><mo separator="true">,</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[a,i-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathit">a</span><span class="mpunct">,</span><span class="mord mathit">i</span><span class="mbin">−</span><span class="mord mathrm">1</span><span class="mclose">]</span></span></span></span>能成功匹配<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>[</mo><mi>p</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi>x</mi><mi mathvariant="normal">.</mi><mi>l</mi><mi>e</mi><mi>n</mi><mi>g</mi><mi>t</mi><mi>h</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">x[p..x.length]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">x</span><span class="mopen">[</span><span class="mord mathit">p</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mord mathit">x</span><span class="mord mathrm">.</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mord mathit">t</span><span class="mord mathit">h</span><span class="mclose">]</span></span></span></span>的最大的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">a</span></span></span></span>。
然后循环这样做：
(在代码中，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>x</mi><mo>=</mo><mo>=</mo><mi>x</mi><mi mathvariant="normal">.</mi><mi>l</mi><mi>e</mi><mi>n</mi><mi>g</mi><mi>t</mi><mi>h</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">lx==x.length-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">x</span><span class="mrel">=</span><span class="mrel">=</span><span class="mord mathit">x</span><span class="mord mathrm">.</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mord mathit">t</span><span class="mord mathit">h</span><span class="mbin">−</span><span class="mord mathrm">1</span></span></span></span>)
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i) &#123;</span><br><span class="line">    ls[i]=f[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span>(c[i]==x[lx]) &#123;</span><br><span class="line">        f[lx]=i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> u,p=lx<span class="number">-1</span>;p;--p) &#123;</span><br><span class="line">            <span class="keyword">if</span>((u=(f[p]?next[f[p]]:first[x[p]]))&lt;f[p+<span class="number">1</span>]) &#123;</span><br><span class="line">                <span class="keyword">do</span> f[p]=u;</span><br><span class="line">                <span class="keyword">while</span>((u=(f[p]?next[f[p]]:first[x[p]]))&lt;f[p+<span class="number">1</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>[</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">x[]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">x</span><span class="mopen">[</span><span class="mclose">]</span></span></span></span>的倒数第二个字符与<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mo>[</mo><mi>i</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">c[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mopen">[</span><span class="mord mathit">i</span><span class="mclose">]</span></span></span></span>相同，那就更新<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mo>[</mo><mi>l</mi><mi>x</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">f[lx]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">x</span><span class="mclose">]</span></span></span></span>。然后<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">p</span></span></span></span>从<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>x</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">lx-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">x</span><span class="mbin">−</span><span class="mord mathrm">1</span></span></span></span>开始枚举，将<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mo>[</mo><mi>p</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">f[p]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathit">p</span><span class="mclose">]</span></span></span></span>挪到最后一个在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mo>[</mo><mi>p</mi><mo>+</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">f[p+1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathit">p</span><span class="mbin">+</span><span class="mord mathrm">1</span><span class="mclose">]</span></span></span></span>之前的颜色为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>[</mo><mi>p</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">x[p]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">x</span><span class="mopen">[</span><span class="mord mathit">p</span><span class="mclose">]</span></span></span></span>的位置。
复杂度？
设<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>[</mo><mi>p</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">x[p]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">x</span><span class="mopen">[</span><span class="mord mathit">p</span><span class="mclose">]</span></span></span></span>在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mo>[</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">c[]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mopen">[</span><span class="mclose">]</span></span></span></span>中出现了<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mo>[</mo><mi>x</mi><mo>[</mo><mi>p</mi><mo>]</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">t[x[p]]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">t</span><span class="mopen">[</span><span class="mord mathit">x</span><span class="mopen">[</span><span class="mord mathit">p</span><span class="mclose">]</span><span class="mclose">]</span></span></span></span>次，那么<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mo>[</mo><mi>p</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">f[p]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathit">p</span><span class="mclose">]</span></span></span></span>至多会向后移动<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.61508em;"></span><span class="strut bottom" style="height:0.61508em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">t</span></span></span></span>次。而<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>[</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">x[]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">x</span><span class="mopen">[</span><span class="mclose">]</span></span></span></span>的元素互异，那么复杂度就是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mo>∑</mo><mi>t</mi><mo>[</mo><mi>x</mi><mo>[</mo><mi>i</mi><mo>]</mo><mo>]</mo><mo>)</mo><mo>=</mo><mi>O</mi><mo>(</mo><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(\sum t[x[i]])=O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1.00001em;vertical-align:-0.25001em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="op-symbol small-op mop" style="top:-0.0000050000000000050004em;">∑</span><span class="mord mathit">t</span><span class="mopen">[</span><span class="mord mathit">x</span><span class="mopen">[</span><span class="mord mathit">i</span><span class="mclose">]</span><span class="mclose">]</span><span class="mclose">)</span><span class="mrel">=</span><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>
处理出来之后，可以发现，随着枚举点<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.65952em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span></span></span></span>右移，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>s</mi><mo>[</mo><mi>i</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">ls[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">s</span><span class="mopen">[</span><span class="mord mathit">i</span><span class="mclose">]</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>s</mi><mo>[</mo><mi>i</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">rs[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">s</span><span class="mopen">[</span><span class="mord mathit">i</span><span class="mclose">]</span></span></span></span>都是单调不降的。因此可以类比莫队，实现<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>计算。
记得特判模式串为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span></span></span></span>的情况</p>
<h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>唯有泪千行。。
KMP--一个指针的均摊--<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>
双指针--两个指针的均摊--<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>
K指针--K个指针的均摊--<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>
只注意到了匹配的第一个点位置的单调性，但没有进一步观察所有点位置的单调性</p>
<h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lucida"</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN=<span class="number">1000000</span>+<span class="number">11</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::reverse;</span><br><span class="line"><span class="keyword">int</span> K;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Calc</span><span class="params">(<span class="keyword">int</span> c[],<span class="keyword">int</span> n,<span class="keyword">int</span> x[],<span class="keyword">int</span> lx,<span class="keyword">int</span> ls[])</span> </span>&#123;</span><br><span class="line">	<span class="comment">//处理出 ls[i] 表示i左边的最靠右的匹配</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> f[MAXN],next[MAXN],first[MAXN];</span><br><span class="line">	<span class="keyword">if</span>(!lx) &#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i)</span><br><span class="line">			ls[i]=i;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=K;++i)</span><br><span class="line">			first[i]=n+<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=n;i&gt;=<span class="number">1</span>;--i) &#123;</span><br><span class="line">			next[i]=first[c[i]];</span><br><span class="line">			first[c[i]]=i;</span><br><span class="line">			f[i]=<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i) &#123;</span><br><span class="line">			ls[i]=f[<span class="number">1</span>];</span><br><span class="line">			<span class="keyword">if</span>(c[i]==x[lx]) &#123;</span><br><span class="line">				f[lx]=i;</span><br><span class="line">				<span class="keyword">for</span>(<span class="keyword">int</span> u,p=lx<span class="number">-1</span>;p;--p) &#123;</span><br><span class="line">					<span class="keyword">if</span>((u=(f[p]?next[f[p]]:first[x[p]]))&lt;f[p+<span class="number">1</span>]) &#123;</span><br><span class="line">						<span class="keyword">do</span> f[p]=u;</span><br><span class="line">						<span class="keyword">while</span>((u=(f[p]?next[f[p]]:first[x[p]]))&lt;f[p+<span class="number">1</span>]);</span><br><span class="line">					&#125; <span class="keyword">else</span></span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> cnt,val[MAXN][<span class="number">2</span>],n;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Modify</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> d,<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(pos==<span class="number">0</span> || pos==n+<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	val[pos][d]+=v;</span><br><span class="line">	<span class="keyword">if</span>(v&gt;<span class="number">0</span> &amp;&amp; val[pos][d]==<span class="number">1</span> &amp;&amp; val[pos][d^<span class="number">1</span>])</span><br><span class="line">		cnt++;</span><br><span class="line">	<span class="keyword">if</span>(v&lt;<span class="number">0</span> &amp;&amp; val[pos][d]==<span class="number">0</span> &amp;&amp; val[pos][d^<span class="number">1</span>])</span><br><span class="line">		cnt--;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//	freopen("input","r",stdin);</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> Ans[MAXN],x[MAXN],y[MAXN],c[MAXN],ls[MAXN],rs[MAXN];</span><br><span class="line">	<span class="keyword">int</span> ac=<span class="number">0</span>,lx,ly;is&gt;&gt;n&gt;&gt;K;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i) is&gt;&gt;c[i];</span><br><span class="line">	is&gt;&gt;lx&gt;&gt;ly;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=lx;++i) is&gt;&gt;x[i];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=ly;++i) is&gt;&gt;y[i];</span><br><span class="line">	Calc(c,n,x,lx<span class="number">-1</span>,ls);</span><br><span class="line">	reverse(c+<span class="number">1</span>,c+<span class="number">1</span>+n);</span><br><span class="line">	Calc(c,n,y,ly<span class="number">-1</span>,rs);</span><br><span class="line">	reverse(c+<span class="number">1</span>,c+<span class="number">1</span>+n);</span><br><span class="line">	reverse(rs+<span class="number">1</span>,rs+<span class="number">1</span>+n);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i) rs[i]=n-rs[i]+<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> p=<span class="number">1</span>;p&lt;ls[<span class="number">1</span>];++p) </span><br><span class="line">		Modify(c[p],<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> p=rs[<span class="number">1</span>]+<span class="number">1</span>;p&lt;=n;++p) </span><br><span class="line">		Modify(c[p],<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span>(c[<span class="number">1</span>]==x[lx] &amp;&amp; cnt)</span><br><span class="line">		Ans[++ac]=<span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=n;++i) &#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> p=ls[i<span class="number">-1</span>];p&lt;=ls[i]<span class="number">-1</span>;++p)</span><br><span class="line">			Modify(c[p],<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> p=rs[i<span class="number">-1</span>]+<span class="number">1</span>;p&lt;=rs[i];++p)</span><br><span class="line">			Modify(c[p],<span class="number">1</span>,<span class="number">-1</span>);</span><br><span class="line">		<span class="keyword">if</span>(c[i]==x[lx] &amp;&amp; cnt)</span><br><span class="line">			Ans[++ac]=i;</span><br><span class="line">	&#125;</span><br><span class="line">	os&lt;&lt;ac&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=ac;++i)</span><br><span class="line">		os&lt;&lt;Ans[i]&lt;&lt;(i==ac?<span class="string">""</span>:<span class="string">" "</span>);</span><br><span class="line">	<span class="comment">//os&lt;&lt;'\n';</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Wa 没有特判1 </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lucida.site/BZOJ3872/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lucida">
      <meta itemprop="description" content="It's been a while.">
      <meta itemprop="image" content="/images/luz.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hey,Lucida is back.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/BZOJ3872/" itemprop="url">
                  BZOJ 3872 Ant colony
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-12 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-12T00:00:00+08:00">2017-03-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-18 18:23:51" itemprop="dateModified" datetime="2018-06-18T18:23:51+08:00">2018-06-18</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Link"><a href="#Link" class="headerlink" title="Link"></a><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=3872" target="_blank" rel="noopener">Link</a></h1><h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><p>真的是叶节点！<del>好吧当我没说</del>
只要知道某一条边需要多少蚂蚁流过就可以了，然而这个流量的取值是一个区间，所以要维护一个区间。一开始naive只维护了最小值。
如果知道了一个点的树边上需要流<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span>，那么这个点就需要有<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mi>d</mi><mi>e</mi><mi>g</mi><mo>[</mo><mi>u</mi><mo>]</mo><mo>∗</mo><mi>l</mi><mo separator="true">,</mo><mo>(</mo><mi>d</mi><mi>e</mi><mi>g</mi><mo>[</mo><mi>u</mi><mo>]</mo><mo>+</mo><mn>1</mn><mo>)</mo><mo>∗</mo><mi>r</mi><mo>−</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[deg[u]*l,(deg[u]+1)*r-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mopen">[</span><span class="mord mathit">u</span><span class="mclose">]</span><span class="mbin">∗</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mopen">(</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mopen">[</span><span class="mord mathit">u</span><span class="mclose">]</span><span class="mbin">+</span><span class="mord mathrm">1</span><span class="mclose">)</span><span class="mbin">∗</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mbin">−</span><span class="mord mathrm">1</span><span class="mclose">]</span></span></span></span>，它下面的边需要有<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mo>(</mo><mi>d</mi><mi>e</mi><mi>g</mi><mo>[</mo><mi>u</mi><mo>]</mo><mo>−</mo><mn>1</mn><mo>)</mo><mo>∗</mo><mi>l</mi><mo separator="true">,</mo><mo>(</mo><mi>d</mi><mi>e</mi><mi>g</mi><mo>[</mo><mi>u</mi><mo>]</mo><mo>−</mo><mn>1</mn><mo>)</mo><mo>∗</mo><mo>(</mo><mi>r</mi><mo>+</mo><mn>1</mn><mo>)</mo><mo>−</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[(deg[u]-1)*l,(deg[u]-1)*(r+1)-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mopen">[</span><span class="mord mathit">u</span><span class="mclose">]</span><span class="mbin">−</span><span class="mord mathrm">1</span><span class="mclose">)</span><span class="mbin">∗</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mopen">(</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mopen">[</span><span class="mord mathit">u</span><span class="mclose">]</span><span class="mbin">−</span><span class="mord mathrm">1</span><span class="mclose">)</span><span class="mbin">∗</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mbin">+</span><span class="mord mathrm">1</span><span class="mclose">)</span><span class="mbin">−</span><span class="mord mathrm">1</span><span class="mclose">]</span></span></span></span>。
注意，即使不乘<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span></span>，合法的群数也会爆int。</p>
<h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lucida"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::sort;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::lower_bound;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::upper_bound;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN=<span class="number">1000000</span>+<span class="number">11</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> to;</span><br><span class="line">	Edge *pre;</span><br><span class="line">	Edge(<span class="keyword">int</span> to,Edge *pre):to(to),pre(pre)&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> *<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span>)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">static</span> Edge *Pool=(Edge*)<span class="built_in">malloc</span>((MAXN&lt;&lt;<span class="number">1</span>)*<span class="keyword">sizeof</span>(Edge)),*Me=Pool;</span><br><span class="line">		<span class="keyword">return</span> Me++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">EdgeList</span> &#123;</span></span><br><span class="line">	Edge *head;<span class="keyword">int</span> deg;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">App</span><span class="params">(<span class="keyword">int</span> to)</span> </span>&#123;</span><br><span class="line">		head=<span class="keyword">new</span> Edge(to,head);</span><br><span class="line">		++deg;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">operator</span> Edge*() &#123;</span><br><span class="line">		<span class="keyword">return</span> head;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;G[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Adde</span><span class="params">(<span class="keyword">int</span> f,<span class="keyword">int</span> t)</span> </span>&#123;</span><br><span class="line">	G[f].App(t);</span><br><span class="line">	G[t].App(f);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> UPLIM,c[MAXN],cc;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">(int64 L,int64 R)</span> </span>&#123;</span><br><span class="line">	<span class="comment">/*int cnt=0;</span></span><br><span class="line"><span class="comment">	for(int i=L;i&lt;=R;++i)</span></span><br><span class="line"><span class="comment">		cnt+=ext[i];*/</span></span><br><span class="line">	<span class="keyword">int</span> p1=lower_bound(c+<span class="number">1</span>,c+<span class="number">1</span>+cc,L)-c,</span><br><span class="line">		p2=upper_bound(c+<span class="number">1</span>,c+<span class="number">1</span>+cc,R)-c<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">if</span>(p1==cc+<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> p2-p1+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">bool</span> ud[MAXN];</span><br><span class="line"><span class="function">int64 <span class="title">DFS</span><span class="params">(<span class="keyword">int</span> pos,int64 lbd,int64 ubd)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//	os&lt;&lt;'&#123;'&lt;&lt;pos&lt;&lt;'&#125;'&lt;&lt;lbd&lt;&lt;' '&lt;&lt;ubd&lt;&lt;'\n';</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(lbd&gt;UPLIM)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	chkmn(ubd,(int64)UPLIM);</span><br><span class="line">	ud[pos]=<span class="number">1</span>;</span><br><span class="line">	int64 res=(G[pos].deg==<span class="number">1</span>?count(lbd*G[pos].deg,(ubd+<span class="number">1</span>)*G[pos].deg<span class="number">-1</span>):<span class="number">0</span>);</span><br><span class="line">	lbd=lbd*(G[pos].deg<span class="number">-1</span>);</span><br><span class="line">	ubd=(ubd+<span class="number">1</span>)*(G[pos].deg<span class="number">-1</span>)<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">for</span>(Edge *e=G[pos];e;e=e-&gt;pre)</span><br><span class="line">		<span class="keyword">if</span>(!ud[e-&gt;to]) &#123;</span><br><span class="line">			<span class="keyword">int</span> u=e-&gt;to;</span><br><span class="line">			res+=DFS(u,lbd,ubd);</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//	freopen("input","r",stdin);</span></span><br><span class="line">	<span class="keyword">int</span> n,K;is&gt;&gt;n&gt;&gt;cc&gt;&gt;K;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=cc;++i) &#123;</span><br><span class="line">		is&gt;&gt;c[i];</span><br><span class="line">		<span class="comment">//ext.Insert(c[i]);ext[c[i]]=1;</span></span><br><span class="line">		chkmx(UPLIM,c[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	sort(c+<span class="number">1</span>,c+<span class="number">1</span>+cc);</span><br><span class="line">	<span class="keyword">int</span> from,to;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n<span class="number">-1</span>;++i) &#123;</span><br><span class="line">		<span class="keyword">int</span> x,y;</span><br><span class="line">		is&gt;&gt;x&gt;&gt;y;</span><br><span class="line">		Adde(x,y);</span><br><span class="line">		<span class="keyword">if</span>(i==<span class="number">1</span>) &#123;</span><br><span class="line">			from=x;</span><br><span class="line">			to=y;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	int64 Ans=<span class="number">0</span>;</span><br><span class="line">	ud[from]=<span class="number">1</span>,ud[to]=<span class="number">0</span>;Ans+=DFS(to,K,K);</span><br><span class="line">	ud[to]=<span class="number">1</span>,ud[from]=<span class="number">0</span>;Ans+=DFS(from,K,K);</span><br><span class="line">	os&lt;&lt;(int64)Ans*K&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 题意读错了</span></span><br><span class="line"><span class="comment"> * 数量爆ll了</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/luz.png"
                alt="Lucida" />
            
              <p class="site-author-name" itemprop="name">Lucida</p>
              <p class="site-description motion-element" itemprop="description">It's been a while.</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">222</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">127</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lucida</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

  
    
      <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0.7.1/dist/katex.min.css" type="text/css">

   
  


  
  

  

  

  

  

  

</body>
</html>
